
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Linux内核启动流程-基于ARM64 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="u-boot引导kernel启动过程.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    计算机基础
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../elf/">
            
                <a href="../elf/">
            
                    
                    ELF
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../elf/linux中ELF二进制程序解析.html">
            
                <a href="../elf/linux中ELF二进制程序解析.html">
            
                    
                    Linux中ELF二进制程序解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="../elf/linux中ELF二进制程序解析----ELF文件实例解析.html">
            
                <a href="../elf/linux中ELF二进制程序解析----ELF文件实例解析.html">
            
                    
                    Linux中ELF二进制程序解析----ELF文件实例解析
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../driver/">
            
                <a href="../driver/">
            
                    
                    Linux driver
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" >
            
                <span>
            
                    
                    BringUp
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="u-boot引导kernel启动过程.html">
            
                <a href="u-boot引导kernel启动过程.html">
            
                    
                    u-boot引导kernel启动过程
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.1.2" data-path="Linux内核启动流程-基于ARM64.html">
            
                <a href="Linux内核启动流程-基于ARM64.html">
            
                    
                    Linux内核启动流程-基于ARM64
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" >
            
                <span>
            
                    
                    Driver
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../driver/Linux字符设备驱动.html">
            
                <a href="../driver/Linux字符设备驱动.html">
            
                    
                    Linux字符设备驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../driver/Linux块设备驱动.html">
            
                <a href="../driver/Linux块设备驱动.html">
            
                    
                    Linux块设备驱动
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../platform/">
            
                <a href="../platform/">
            
                    
                    platform
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="../platform/platform总线设备驱动模型.html">
            
                <a href="../platform/platform总线设备驱动模型.html">
            
                    
                    platform总线设备驱动模型
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../tty/">
            
                <a href="../tty/">
            
                    
                    tty
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../i2c/">
            
                <a href="../i2c/">
            
                    
                    i2c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../tool/">
            
                <a href="../tool/">
            
                    
                    Tool
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" >
            
                <span>
            
                    
                    qemu
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="../qemu/Qemu搭建ARM-vexpress开发环境-1.html">
            
                <a href="../qemu/Qemu搭建ARM-vexpress开发环境-1.html">
            
                    
                    Qemu搭建ARM-vexpress开发环境-1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="../qemu/Qemu搭建ARM-vexpress开发环境-2-u-boot启动kernel.html">
            
                <a href="../qemu/Qemu搭建ARM-vexpress开发环境-2-u-boot启动kernel.html">
            
                    
                    Qemu搭建ARM-vexpress开发环境-2-u-boot启动kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.3" data-path="../qemu/Qemu搭建ARM-vexpress开发环境-3-NFS网络根文件系统.html">
            
                <a href="../qemu/Qemu搭建ARM-vexpress开发环境-3-NFS网络根文件系统.html">
            
                    
                    Qemu搭建ARM-vexpress开发环境-3-NFS网络根文件系统
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../hexo/">
            
                <a href="../hexo/">
            
                    
                    hexo
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../hexo/Hexo-Github搭建个人博客.html">
            
                <a href="../hexo/Hexo-Github搭建个人博客.html">
            
                    
                    Hexo-Github搭建个人博客
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="../hexo/Ubuntu-Hexo-Github搭建个人博客.html">
            
                <a href="../hexo/Ubuntu-Hexo-Github搭建个人博客.html">
            
                    
                    Ubuntu-Hexo-Github搭建个人博客
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Linux内核启动流程-基于ARM64</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p>&#x4EE5;arm64&#x4E3A;&#x4F8B;&#xFF0C;&#x7B80;&#x5355;&#x8BB2;&#x8FF0;Linux&#x5728;ARM64&#x67B6;&#x6784;&#x8BBE;&#x5907;&#x4E0A;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x7684;&#x91CD;&#x8981;&#x6D41;&#x7A0B;&#xFF1B;</p>
<!--more-->
<h3 id="&#x76EE;&#x5F55;">&#x76EE;&#x5F55;</h3>
<p>[TOC]</p>
<h3 id="0-&#x7B80;&#x8FF0;">0. &#x7B80;&#x8FF0;</h3>
<p>&#x4EE5;arm64&#x4E3A;&#x4F8B;&#xFF0C;&#x8BB2;&#x8FF0;Linux&#x5728;ARM64&#x67B6;&#x6784;&#x8BBE;&#x5907;&#x4E0A;&#x7684;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF1B;</p>
<p>&#x4E0A;&#x7535;&#x542F;&#x52A8;&#xFF0C;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x8981;&#x7ECF;&#x8FC7;uboot&#x3001;kernel&#x3001;filesystem&#x3001;ADM&#x51E0;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-mermaid">graph LR
    uboot(uboot)--&gt;kernel(kernel)
    --&gt;filesystem(filesystem)
    --&gt;Software(Software)
</code></pre>
<p>&#x5728;&#x5927;&#x591A;&#x6570;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x5185;&#x6838;&#x955C;&#x50CF;&#x5728;uboot&#x9636;&#x6BB5;&#x88AB;&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x63A7;&#x5236;&#x6743;&#x5F00;&#x59CB;&#x5185;&#x6838;&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF1B;</p>
<pre><code class="lang-mermaid">graph LR
    uboot(uboot)--&gt;kernel(kernel)
</code></pre>
<p>Linux&#x5185;&#x6838;&#x7248;&#x672C;&#xFF1A;</p>
<pre><code class="lang-shell">linux-4.9.115
# uname -a
Linux vexpress 4.9.115 #2 SMP Wed Apr 1 22:49:35 CST 2020 aarch64 GNU/Linux
</code></pre>
<p><strong>&#x8BF4;&#x660E;</strong>&#xFF1A;&#x7531;&#x4E8E;Linux&#x5185;&#x6838;&#x7CFB;&#x7EDF;&#x5E9E;&#x5927;&#x7E41;&#x6742;&#xFF0C;&#x8981;&#x60F3;&#x628A;&#x5185;&#x6838;&#x542F;&#x52A8;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x7EC6;&#x8282;&#x90FD;&#x63CF;&#x8FF0;&#x6E05;&#x695A;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x4E0D;&#x53EF;&#x80FD;&#xFF0C;&#x66F4;&#x4F55;&#x51B5;&#x4F5C;&#x8005;&#x80FD;&#x529B;&#x6C34;&#x5E73;&#x4E5F;&#x8FBE;&#x4E0D;&#x5230;&#xFF1B;&#x56E0;&#x6B64;&#xFF0C;&#x5C31;&#x5728;&#x8FFD;&#x8E2A;&#x5185;&#x6838;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x53EA;&#x63CF;&#x8FF0;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x51E0;&#x4E2A;&#x90E8;&#x5206;&#xFF1B;&#x53EF;&#x4EE5;&#x5728;&#x4EE5;&#x540E;&#x7684;&#x5DE5;&#x4F5C;&#x3001;&#x5B66;&#x4E60;&#x4E2D;&#xFF0C;&#x968F;&#x7740;&#x6C34;&#x5E73;&#x7684;&#x63D0;&#x9AD8;&#xFF0C;&#x4E0D;&#x65AD;&#x5730;&#x589E;&#x52A0;&#x5185;&#x5BB9;&#xFF1B;</p>
<h3 id="1-&#x76EE;&#x6807;&#x6587;&#x4EF6;">1. &#x76EE;&#x6807;&#x6587;&#x4EF6;</h3>
<p>&#x5185;&#x6838;&#x7F16;&#x8BD1;&#x540E;&#x751F;&#x6210;&#x7684;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x662F;ELF&#x683C;&#x5F0F;&#x7684;vmlinux&#xFF0C;vmlinux&#x6587;&#x4EF6;&#x662F;&#x5404;&#x4E2A;&#x6E90;&#x4EE3;&#x7801;&#x6309;&#x7167;vmlinux.lds&#x8BBE;&#x5B9A;&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x94FE;&#x63A5;&#x540E;&#x5F97;&#x5230;&#x7684;Object&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x4E0D;&#x80FD;&#x5728;ARM&#x5E73;&#x53F0;&#x4E0A;&#x8FD0;&#x884C;&#xFF1B;&#x901A;&#x5E38;&#x4F1A;&#x5BF9;&#x5176;&#x538B;&#x7F29;&#xFF0C;&#x751F;&#x6210;zImage&#x6216;bzImage&#xFF1B;&#x901A;&#x5E38;&#x5185;&#x6838;&#x6620;&#x50CF;&#x4EE5;&#x538B;&#x7F29;&#x683C;&#x5F0F;&#x5B58;&#x50A8;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x7684;&#x5185;&#x6838;&#xFF1B;&#x56E0;&#x6B64;&#x5185;&#x6838;&#x9636;&#x6BB5;&#x9700;&#x8981;&#x5148;&#x5BF9;&#x5185;&#x6838;&#x6620;&#x50CF;&#x81EA;&#x89E3;&#x538B;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684;&#x6587;&#x4EF6;&#x5934;&#x90E8;&#x6253;&#x5305;&#x6709;&#x89E3;&#x538B;&#x7F29;&#x7A0B;&#x5E8F;&#xFF1B;</p>
<h4 id="11-vmlinuxlds">1.1 vmlinux.lds</h4>
<p>vmlinux.lds&#x6587;&#x4EF6;&#x662F;&#x5728;&#x5185;&#x6838;&#x7F16;&#x8BD1;&#x65F6;&#x751F;&#x6210;&#x7684;&#xFF0C;&#x662F;&#x88AB;&#x7981;&#x6B62;&#x7F16;&#x8F91;&#x7684;&#xFF1B;vmlinux.lds&#x6587;&#x4EF6;&#x662F;&#x5728;&#x7F16;&#x8BD1;&#x65F6;&#xFF0C;&#x7531;vmlinux.lds.S&#x6587;&#x4EF6;&#x5BF9;&#x94FE;&#x63A5;&#x5668;ld&#x7684;&#x8F93;&#x51FA;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x540E;&#x751F;&#x6210;&#xFF1B;vmlinux.lds.S&#x662F;&#x7528;&#x6765;&#x5BF9;&#x8F93;&#x51FA;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x6BB5;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x5E76;&#x5B9A;&#x4E49;&#x76F8;&#x5173;&#x7684;&#x7B26;&#x53F7;&#x540D;&#xFF1B;</p>
<pre><code>arch/arm64/kernel/vmlinux.lds.S
</code></pre><p>&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x901A;&#x8FC7;make&#x65F6;&#x6307;&#x5B9A;&#x7684;&#x53C2;&#x6570;-O&#xFF0C;&#x5C06;&#x5185;&#x6838;&#x7F16;&#x8BD1;&#x751F;&#x6210;&#x7684;&#x6240;&#x6709;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#xFF0C;&#x5305;&#x62EC;vmlinux.lds&#x6587;&#x4EF6;&#x91CD;&#x5B9A;&#x5411;&#x8F93;&#x51FA;&#x5230;&#x4EE5;&#x4E0B;&#x76EE;&#x5F55;&#xFF1A;</p>
<pre><code class="lang-shell">arch/arm64/kernel/vmlinux.lds
</code></pre>
<p>vmlinux.lds&#x6587;&#x4EF6;&#x662F;&#x94FE;&#x63A5;&#x811A;&#x672C;&#xFF0C;&#x5728;&#x5185;&#x6838;&#x7F16;&#x8BD1;&#x65F6;&#xFF0C;&#x4F5C;&#x4E3A;Makefile&#x7684;&#x94FE;&#x63A5;&#x5668;&#x811A;&#x672C;&#xFF0C;&#x53C2;&#x4E0E;&#x94FE;&#x63A5;&#x751F;&#x6210;&#x5185;&#x6838;&#x6620;&#x50CF;vmlinux&#xFF1B;</p>
<p>&#x603B;&#x4E4B;&#xFF1A;vmlinux&#x662F;&#x6309;&#x7167;vmlinux.lds&#x94FE;&#x63A5;&#x751F;&#x6210;&#x7684;&#xFF0C;&#x800C;vmlinux.lds&#x662F;&#x7531;vmlinux.lds.S&#x751F;&#x6210;&#x7684;&#xFF1B;</p>
<pre><code class="lang-C"><span class="hljs-comment">// arch/arm64/kernel/vmlinux.lds</span>
OUTPUT_ARCH(aarch64)    <span class="hljs-comment">// &#x6307;&#x5B9A;&#x67B6;&#x6784;&#x4E3A;aarch64</span>
ENTRY(_text)            <span class="hljs-comment">// &#x5B9A;&#x4E49;&#x5165;&#x53E3;&#x4E3A;_text</span>
jiffies = jiffies_64;    <span class="hljs-comment">// &#x5B9A;&#x4E49;&#x4E3A;64&#x4F4D;&#x8BA1;&#x6570;&#x5668;</span>
SECTIONS
{
    ......
    <span class="hljs-comment">// &#x6307;&#x5B9A;&#x94FE;&#x63A5;&#x5730;&#x5740;</span>
    . = ((((<span class="hljs-number">0xffffffffffffffff</span> - (<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">48</span>)) + <span class="hljs-number">1</span>) + (<span class="hljs-number">0</span>)) + (<span class="hljs-number">0x08000000</span>))) + <span class="hljs-number">0x00080000</span>;
    ......
}
</code></pre>
<p>&#x5173;&#x4E8E;&#x6BB5;&#x7684;&#x4FE1;&#x606F;</p>
<blockquote>
<p>text&#x6BB5;&#xFF0C;&#x4EE3;&#x7801;&#x6BB5;&#xFF0C;&#x7528;&#x6765;&#x5B58;&#x653E;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x7684;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF1B;&#x5927;&#x5C0F;&#x5728;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x524D;&#x786E;&#x5B9A;&#xFF1B;</p>
<p>data&#x6BB5;&#xFF0C;&#x6570;&#x636E;&#x6BB5;&#xFF0C;&#x7528;&#x6765;&#x5B58;&#x653E;&#x7A0B;&#x5E8F;&#x4E2D;&#x5DF2;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF1B;&#x6570;&#x636E;&#x6BB5;&#x5C5E;&#x4E8E;&#x9759;&#x6001;&#x5185;&#x5B58;&#x5206;&#x914D;&#xFF1B;</p>
<p>bss&#x6BB5;&#xFF0C;&#x7528;&#x6765;&#x5B58;&#x653E;&#x7A0B;&#x5E8F;&#x4E2D;&#x672A;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x548C;&#x9759;&#x6001;&#x53D8;&#x91CF;&#x7684;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF1B;&#x5C5E;&#x4E8E;&#x9759;&#x6001;&#x5185;&#x5B58;&#x5206;&#x914D;&#xFF1B;</p>
<p>init&#x6BB5;&#xFF0C;Linux&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x79CD;&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x624D;&#x80FD;&#x7528;&#x5230;&#x7684;&#x6BB5;&#xFF1B;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x8BE5;&#x6BB5;&#x5185;&#x5B58;&#x4F1A;&#x88AB;&#x91CA;&#x653E;&#xFF1B;</p>
</blockquote>
<p>&#x5173;&#x4E8E;&#x5730;&#x5740;&#x7684;&#x4FE1;&#x606F;</p>
<blockquote>
<p>&#x52A0;&#x8F7D;&#x5730;&#x5740;&#xFF1A;&#x7A0B;&#x5E8F;&#x4E2D;&#x6307;&#x4EE4;&#x548C;&#x53D8;&#x91CF;&#x7B49;&#x52A0;&#x8F7D;&#x5230;RAM&#x4E0A;&#x7684;&#x5730;&#x5740;&#xFF1B;</p>
<p>&#x8FD0;&#x884C;&#x5730;&#x5740;&#xFF1A;CPU&#x6267;&#x884C;&#x4E00;&#x6761;&#x7A0B;&#x5E8F;&#x7684;&#x6307;&#x4EE4;&#x65F6;&#x7684;&#x6267;&#x884C;&#x5730;&#x5740;&#xFF0C;&#x5373;PC&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF1B;&#x5C31;&#x662F;&#x8981;&#x5BFB;&#x5740;&#x5230;&#x4E00;&#x4E2A;&#x6307;&#x4EE4;&#x6216;&#x53D8;&#x91CF;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#xFF1B;</p>
<p>&#x94FE;&#x63A5;&#x5730;&#x5740;&#xFF1A;&#x94FE;&#x63A5;&#x8FC7;&#x7A0B;&#x4E2D;&#x94FE;&#x63A5;&#x5668;&#x4E3A;&#x6307;&#x4EE4;&#x548C;&#x53D8;&#x91CF;&#x5206;&#x914D;&#x7684;&#x5730;&#x5740;&#xFF1B;</p>
</blockquote>
<h4 id="12-&#x5185;&#x6838;&#x6620;&#x50CF;">1.2 &#x5185;&#x6838;&#x6620;&#x50CF;</h4>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x5185;&#x6838;&#xFF0C;&#x662F;&#x751F;&#x6210;&#x7684;&#x7EAF;&#x5185;&#x6838;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#xFF0C;&#x5177;&#x6709;&#x7528;&#x6237;&#x5B9A;&#x4E49;&#x7684;&#x6240;&#x6709;&#x5185;&#x6838;&#x7EC4;&#x4EF6;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;vmlinux&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#x662F;&#x65E0;&#x6CD5;&#x542F;&#x52A8;&#x7CFB;&#x7EDF;&#x7684;&#xFF1B;&#x4E3A;&#x4E86;&#x5C06;Linux&#x5185;&#x6838;&#x6620;&#x50CF;&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x5E76;&#x5904;&#x4E8E;&#x53EF;&#x6267;&#x884C;&#x72B6;&#x6001;&#xFF0C;&#x5185;&#x6838;&#x6784;&#x5EFA;&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;objcopy&#x547D;&#x4EE4;&#x6E05;&#x9664;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x8282;&#x533A;&#xFF0C;&#x538B;&#x7F29;ELF&#x683C;&#x5F0F;&#x7684;vmlinux&#xFF0C;&#x901A;&#x8FC7;&#x5F15;&#x5BFC;&#x7A0B;&#x5E8F;&#x52A0;&#x8F7D;&#x9879;&#x548C;&#x94FE;&#x63A5;&#xFF0C;&#x751F;&#x6210;&#x53EF;&#x542F;&#x52A8;&#x7684;&#x6700;&#x7EC8;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;zImage&#xFF1B;</p>
<p>vmlinux&#x901A;&#x8FC7;gzip&#x538B;&#x7F29;&#x6210;piggy.o&#xFF0C;&#x548C;head.o&#x3001;misc.o&#x94FE;&#x63A5;&#x751F;&#x6210;zImage&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#xFF1B;</p>
<p>vmlinuz&#x662F;vmlinux&#x7684;&#x538B;&#x7F29;&#x6587;&#x4EF6;</p>
<p>zImage&#x9ED8;&#x8BA4;&#x7684;&#x538B;&#x7F29;&#x5185;&#x6838;&#x6620;&#x50CF;&#x6587;&#x4EF6;&#xFF0C;&#x538B;&#x7F29;vmlinux&#xFF0C;&#x52A0;&#x4E0A;&#x4E00;&#x6BB5;&#x89E3;&#x538B;&#x542F;&#x52A8;&#x4EE3;&#x7801;&#xFF0C;&#x538B;&#x7F29;&#x800C;&#x6210;&#xFF1B;</p>
<p>uImage&#x662F;u-boot&#x4F7F;&#x7528;bootm&#x547D;&#x4EE4;&#x5F15;&#x5BFC;&#x7684;Linux&#x538B;&#x7F29;&#x5185;&#x6838;&#x6620;&#x50CF;&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#xFF0C;&#x662F;&#x4F7F;&#x7528;mkimage&#x5DE5;&#x5177;&#x5BF9;&#x666E;&#x901A;&#x7684;&#x538B;&#x7F29;&#x5185;&#x6838;&#x6620;&#x50CF;&#x6587;&#x4EF6;&#xFF08;zImage&#xFF09;&#x52A0;&#x5DE5;&#x800C;&#x6210;&#xFF1B;</p>
<p>uImage&#x662F;uboot&#x4E13;&#x7528;&#x7684;&#x5185;&#x6838;&#x6620;&#x50CF;&#x6587;&#x4EF6;&#xFF0C;&#x662F;&#x5728;zImage&#x4E4B;&#x524D;&#x52A0;&#x4E0A;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x4E3A;64&#x5B57;&#x8282;&#x7684;&#x201C;&#x5934;&#x201D;&#xFF0C;&#x8BF4;&#x660E;&#x5185;&#x6838;&#x7684;&#x7248;&#x672C;&#x3001;&#x52A0;&#x8F7D;&#x4F4D;&#x7F6E;&#x3001;&#x751F;&#x6210;&#x65F6;&#x95F4;&#x3001;&#x5927;&#x5C0F;&#x7B49;&#x4FE1;&#x606F;&#xFF1B;&#x5728;&#x5730;&#x5740;0x40&#x4E4B;&#x540E;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x548C;zImage&#x4E00;&#x6837;&#xFF1B;&#x5176;&#x5927;&#x5C0F;&#x6BD4;zImage&#x5927;64&#x5B57;&#x8282;&#xFF1B;</p>
<h4 id="13-&#x8BBE;&#x5907;&#x6811;&#x6587;&#x4EF6;">1.3 &#x8BBE;&#x5907;&#x6811;&#x6587;&#x4EF6;</h4>
<p>Linux&#x5185;&#x6838;&#x4ECE;3.x&#x7248;&#x672C;&#x5F00;&#x59CB;&#x5F15;&#x5165;&#x8BBE;&#x5907;&#x6811;&#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x7528;&#x4E8E;&#x5B9E;&#x73B0;&#x9A71;&#x52A8;&#x4EE3;&#x7801;&#x4E0E;&#x8BBE;&#x5907;&#x4FE1;&#x606F;&#x5206;&#x79BB;&#xFF1B;&#x8BBE;&#x5907;&#x6811;&#x51FA;&#x73B0;&#x4E4B;&#x524D;&#xFF0C;&#x6240;&#x6709;&#x5173;&#x4E8E;&#x8BBE;&#x5907;&#x7684;&#x5177;&#x4F53;&#x4FE1;&#x606F;&#x90FD;&#x5199;&#x5728;&#x9A71;&#x52A8;&#x4E2D;&#xFF0C;&#x5916;&#x56F4;&#x8BBE;&#x5907;&#x53D8;&#x5316;&#xFF0C;&#x9A71;&#x52A8;&#x4EE3;&#x7801;&#x5C31;&#x8981;&#x8DDF;&#x7740;&#x4FEE;&#x6539;&#x751A;&#x81F3;&#x662F;&#x91CD;&#x5199;&#xFF1B;&#x5F15;&#x5165;&#x8BBE;&#x5907;&#x6811;&#x4E4B;&#x540E;&#xFF0C;&#x9A71;&#x52A8;&#x4EE3;&#x7801;&#x53EA;&#x8D1F;&#x8D23;&#x5904;&#x7406;&#x9A71;&#x52A8;&#x4EE3;&#x7801;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x800C;&#x5173;&#x4E8E;&#x8BBE;&#x5907;&#x7684;&#x5177;&#x4F53;&#x4FE1;&#x606F;&#x5B58;&#x653E;&#x5230;&#x8BBE;&#x5907;&#x6811;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x8FD9;&#x6837;&#x786C;&#x4EF6;&#x63A5;&#x53E3;&#x4FE1;&#x606F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x8BBE;&#x5907;&#x6811;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x9A71;&#x52A8;&#x4EE3;&#x7801;&#x5C31;&#x53EF;&#x4EE5;&#xFF1B;</p>
<p>&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x7F16;&#x8BD1;&#x8BBE;&#x5907;&#x6811;&#x4E4B;&#x524D;&#xFF0C;&#x5148;&#x5728;scripts/dtc/&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x7F16;&#x8BD1;&#x751F;&#x6210;dtc&#x5DE5;&#x5177;scripts/dtc/dtc&#xFF0C;&#x518D;&#x4F7F;&#x7528;&#x751F;&#x6210;&#x7684;dtc&#x5DE5;&#x5177;&#x7F16;&#x8BD1;&#x8BBE;&#x5907;&#x6811;&#x6E90;&#x7801;&#xFF0C;&#x751F;&#x6210;&#x8BBE;&#x5907;&#x6811;&#x6587;&#x4EF6;&#xFF1B;&#x8BBE;&#x5907;&#x6811;&#x6E90;&#x7801;&#x548C;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5728;arch/arm64/boot/dts/freescale/&#x76EE;&#x5F55;&#xFF1B;</p>
<p>&#x5728;Lx2160&#x677F;&#x9879;&#x76EE;&#x4E2D;&#xFF0C;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x4F1A;&#x88AB;&#x91CD;&#x5B9A;&#x5411;&#x8F93;&#x51FA;&#x5230;target&#x76EE;&#x5F55;&#xFF1B;</p>
<p>&#x5177;&#x4F53;&#x7684;&#x8BBE;&#x5907;&#x6811;&#x6587;&#x4EF6;&#x7684;&#x52A0;&#x8F7D;&#x3001;&#x89E3;&#x6790;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F1A;&#x5728;&#x4E0B;&#x6587;setup_arch&#x90E8;&#x5206;&#x63CF;&#x8FF0;&#xFF1B;</p>
<h3 id="2-&#x5185;&#x6838;&#x542F;&#x52A8;&#x7B2C;&#x4E00;&#x9636;&#x6BB5;">2. &#x5185;&#x6838;&#x542F;&#x52A8;&#x7B2C;&#x4E00;&#x9636;&#x6BB5;</h3>
<p>Linux&#x5185;&#x6838;&#x542F;&#x52A8;&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5E38;&#x8BF4;&#x7684;&#x6C47;&#x7F16;&#x9636;&#x6BB5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;stext&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#x5185;&#x5BB9;&#xFF1B;&#x8FD9;&#x90E8;&#x5206;&#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x7684;&#x5DE5;&#x4F5C;&#xFF1A;CPU ID&#x68C0;&#x67E5;&#xFF0C;machine ID&#x68C0;&#x67E5;&#xFF0C;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x5316;&#x9875;&#x8868;&#xFF0C;&#x8BBE;&#x7F6E;C&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x5185;&#x6838;&#x7B2C;&#x4E00;&#x4E2A;&#x771F;&#x6B63;&#x7684;C&#x51FD;&#x6570;start_kernel&#x6267;&#x884C;&#xFF1B;</p>
<p>&#x8BBE;&#x7F6E;&#x4E3A;SVC&#x6A21;&#x5F0F;&#xFF0C;&#x5173;&#x95ED;&#x6240;&#x6709;&#x4E2D;&#x65AD;</p>
<p>&#x83B7;&#x53D6;CPUID&#xFF0C;&#x63D0;&#x53D6;&#x76F8;&#x5E94;&#x7684;proc info</p>
<p>&#x9A8C;&#x8BC1;tags&#x6216;dtb</p>
<p>&#x521B;&#x5EFA;&#x9875;&#x8868;&#x9879;</p>
<p>head.S&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;</p>
<p>&#x6821;&#x9A8C;&#x542F;&#x52A8;&#x5408;&#x6CD5;&#x6027;</p>
<p>&#x5EFA;&#x7ACB;&#x6BB5;&#x5F0F;&#x6620;&#x5C04;&#x7684;&#x9875;&#x8868;&#x5E76;&#x5F00;&#x542F;MMU</p>
<p>&#x6784;&#x5EFA;C&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x8DF3;&#x5165;C&#x9636;&#x6BB5;</p>
<h4 id="21-&#x5185;&#x6838;&#x542F;&#x52A8;&#x5165;&#x53E3;&#x70B9;">2.1 &#x5185;&#x6838;&#x542F;&#x52A8;&#x5165;&#x53E3;&#x70B9;</h4>
<p>&#x5185;&#x6838;&#x662F;&#x4E00;&#x4E2A;&#x5E9E;&#x5927;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x901A;&#x8FC7;vmlinux&#x53CD;&#x5411;&#x8FFD;&#x8E2A;&#x542F;&#x52A8;&#x5165;&#x53E3;&#x70B9;</p>
<p>Lx2160le&#x677F;&#x7684;&#x4EA4;&#x53C9;&#x7F16;&#x8BD1;&#x5DE5;&#x5177;&#x94FE;&#xFF1A;</p>
<pre><code class="lang-shell">CROSS_COMPILE=aarch64-linux-gnu-
</code></pre>
<p>&#x901A;&#x8FC7;&#x5BF9;&#x76EE;&#x6807;&#x6587;&#x4EF6;vmlinux&#x7684;&#x53CD;&#x5411;&#x8FFD;&#x6EAF;&#xFF0C;&#x627E;&#x5230;Linux&#x6267;&#x884C;&#x7684;&#x5165;&#x53E3;&#xFF1B;</p>
<p>&#x4F7F;&#x7528;readelf&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x67E5;&#x770B;vmlinux&#x7684;&#x5165;&#x53E3;&#x5730;&#x5740;&#x4E3A;&#xFF1A;0xffff000008080000</p>
<pre><code class="lang-shell"># readelf -h vmlinux
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              2&apos;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           AArch64
  Version:                           0x1
  Entry point address:               0xffff000008080000
  Start of program headers:          64 (bytes into file)
  Start of section headers:          267014976 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         4
  Size of section headers:           64 (bytes)
  Number of section headers:         39
  Section header string table index: 36
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x5165;&#x53E3;&#x5730;&#x5740;&#x662F;&#x600E;&#x4E48;&#x6765;&#x7684;&#xFF0C;&#x5BF9;&#x5E94;&#x5185;&#x6838;&#x4EE3;&#x7801;&#x4E2D;&#x7684;&#x54EA;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53CD;&#x6C47;&#x7F16;&#x6765;&#x5206;&#x6790;&#xFF1B;</p>
<pre><code class="lang-shell"># aarch64-linux-gnu-objdump -dxh vmlinux &gt; vmlinux.s
</code></pre>
<p>&#x5728;&#x5F97;&#x5230;&#x7684;&#x6C47;&#x7F16;&#x6587;&#x4EF6;vmlinux.s&#x4E2D;&#x67E5;&#x627E;&#x5165;&#x53E3;&#x5730;&#x5740;&#xFF1A;0xffff000008080000</p>
<pre><code class="lang-c">start address <span class="hljs-number">0xffff000008080000</span>

Disassembly of section .head.text:

ffff000008080000 &lt;_text&gt;:
ffff000008080000:       <span class="hljs-number">91005</span>a4d        add     x13, x18, <span class="hljs-meta">#0x16</span>
ffff000008080004:       <span class="hljs-number">14437f</span>ff        b       ffff000009160000 &lt;stext&gt;
</code></pre>
<p>&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#xFF0C;Linux&#x5165;&#x53E3;&#x7684;&#x7B2C;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x4E3A;&#xFF1A;add     x13, x18, #0x16&#xFF1B;&#x5BF9;&#x5E94;&#x7684;&#x7B26;&#x53F7;&#x662F;&#xFF1A;.head.text  _text&#xFF1B;</p>
<p>&#x800C;.head.text&#x6BB5;&#xFF0C;&#x901A;&#x8FC7;include/linux/init.h&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x5B8F;&#x5B9A;&#x4E49;__HEAD&#x6765;&#x8868;&#x793A;&#xFF1A;</p>
<pre><code class="lang-C"><span class="hljs-comment">/* For assembly routines */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __HEAD      .section    <span class="hljs-string">&quot;.head.text&quot;</span>,<span class="hljs-string">&quot;ax&quot;</span>    <span class="hljs-comment">// &quot;ax&quot;&#x8868;&#x793A;&#x6240;&#x5728;&#x6BB5;&#x533A;&#x57DF;&#x6709;&#x53EF;&#x6267;&#x884C;&#x6743;&#x9650;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __INIT      .section    <span class="hljs-string">&quot;.init.text&quot;</span>,<span class="hljs-string">&quot;ax&quot;</span></span>
</code></pre>
<p>&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x5165;&#x53E3;&#x70B9;&#xFF0C;&#x5728;arch/arm64/kernel/head.S&#x6587;&#x4EF6;&#x4E2D;&#xFF1B;</p>
<pre><code class="lang-c">    __HEAD
_head:
    <span class="hljs-comment">/*
     * DO NOT MODIFY. Image header expected by Linux boot-loaders.
     */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_EFI</span>
    <span class="hljs-comment">/*
     * This add instruction has no meaningful effect except that
     * its opcode forms the magic &quot;MZ&quot; signature required by UEFI.
     */</span>
    add x13, x18, <span class="hljs-meta">#0x16</span>
    b   stext
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    b   stext               <span class="hljs-comment">// branch to kernel start, magic</span>
    .<span class="hljs-keyword">long</span>   <span class="hljs-number">0</span>               <span class="hljs-comment">// reserved</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<p>&#x5230;&#x6B64;&#xFF0C;&#x5DF2;&#x7ECF;&#x627E;&#x5230;&#xFF0C;&#x76EE;&#x6807;&#x6587;&#x4EF6;vmlinux&#x7684;&#x5165;&#x53E3;&#x662F;arch/arm64/kernel/head.S&#x6587;&#x4EF6;&#x4E2D;&#x7684;__HEAD&#xFF0C;&#x5728;&#x6267;&#x884C;&#x5B8C;&#x7B2C;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#xFF08;add x13, x18, #0x16&#xFF09;&#x4E4B;&#x540E;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;stext&#x51FD;&#x6570;&#x6267;&#x884C;&#xFF08;b   stext&#xFF09;&#xFF1B;&#x6240;&#x4EE5;&#xFF0C;&#x52A0;&#x8F7D;vmlinux&#x540E;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x8FD0;&#x884C;&#x7684;&#x51FD;&#x6570;&#x662F;stext&#xFF1B;</p>
<h4 id="22-stext&#x51FD;&#x6570;">2.2 stext&#x51FD;&#x6570;</h4>
<p>&#x542F;&#x52A8;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x6C47;&#x7F16;&#x9636;&#x6BB5;&#xFF0C;&#x662F;&#x4ECE;arch/arm64/kernel/head.S&#x6587;&#x4EF6;&#x5F00;&#x59CB;&#xFF0C;&#x6267;&#x884C;&#x7684;&#x8D77;&#x70B9;&#x662F;stext&#x51FD;&#x6570;&#xFF0C;&#x5165;&#x53E3;&#x51FD;&#x6570;&#x662F;&#x901A;&#x8FC7;vmlinux.lds&#x94FE;&#x63A5;&#x800C;&#x6210;&#xFF0C;&#x5728;head.S&#x4E2D;ENTRY(stext)&#x6307;&#x5B9A;&#xFF1B;</p>
<p>&#x5728;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x4E2D;&#xFF0C;&#x5B8F;&#x5B9A;&#x4E49;ENTRY&#x548C;ENDPROC&#x662F;&#x6210;&#x5BF9;&#x51FA;&#x73B0;&#x7684;&#xFF0C;&#x8868;&#x793A;&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x8981;&#x6307;&#x660E;&#x5F53;&#x524D;&#x4EE3;&#x7801;&#x6240;&#x5728;&#x7684;&#x6BB5;&#xFF0C;&#x5982;&#xFF1A;__INIT&#xFF1B;</p>
<pre><code class="lang-c">// arch/arm64/kernel/head.S
#define __INIT      .section    &quot;.init.text&quot;,&quot;ax&quot;

    __INIT
ENTRY(stext)
    ......
ENDPROC(stext)
</code></pre>
<p>&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x5FC5;&#x8981;&#x6761;&#x4EF6;&#xFF1A;MMU&#x5173;&#x95ED;&#xFF0C;D-cache&#x5173;&#x95ED;&#xFF0C;x0&#x662F;&#x4F20;&#x9012;&#x7ED9;FDT blob&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#xFF1B;</p>
<pre><code class="lang-c"> * The requirements are:
 *   MMU = off, D-cache = off, I-cache = on or off,
 *   x0 = physical address to the FDT blob.
</code></pre>
<p>stext&#x51FD;&#x6570;&#x5F00;&#x59CB;&#x6267;&#x884C;&#xFF1B;</p>
<pre><code class="lang-c">// arch/arm64/kernel/head.S
    __INIT
ENTRY(stext)
    bl  preserve_boot_args    // Preserve the arguments passed by the bootloader in x0 ... x3
    bl  el2_setup           // Drop to EL1, w0=cpu_boot_mode
    adrp    x23, __PHYS_OFFSET
    and x23, x23, MIN_KIMG_ALIGN - 1    // KASLR offset, defaults to 0
    bl  set_cpu_boot_mode_flag
    bl  __create_page_tables

  /*
   * The following calls CPU setup code, see arch/arm64/mm/proc.S for
   * details.
   * On return, the CPU will be ready for the MMU to be turned on and
   * the TCR will have been set.
   */
     bl  __cpu_setup         // initialise processor
     b   __primary_switch
ENDPROC(stext)
</code></pre>
<h5 id="1-preservebootargs">1. preserve_boot_args</h5>
<p>&#x4FDD;&#x5B58;&#x4ECE;bootloader&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;x0 ~ x3&#x53C2;&#x6570;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/head.S</span>
preserve_boot_args:
    mov x21, x0                <span class="hljs-comment">// &#x5C06;dtb&#x7684;&#x5730;&#x5740;&#x6682;&#x5B58;&#x5728;x21&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x91CA;&#x653E;&#x51FA;x0&#x4F7F;&#x7528;</span>
    adr_l   x0, boot_args    <span class="hljs-comment">// x0&#x4FDD;&#x5B58;boot_args&#x53D8;&#x91CF;&#x7684;&#x5730;&#x5740;</span>
    stp x21, x1, [x0]        <span class="hljs-comment">// &#x5C06;x0&#x3001;x1&#x7684;&#x503C;&#x4FDD;&#x5B58;&#x5230;boot_args[0]&#x3001;boot_args[1]</span>
    stp x2, x3, [x0, <span class="hljs-meta">#16]    <span class="hljs-comment">// &#x5C06;x2&#x3001;x3&#x7684;&#x503C;&#x4FDD;&#x5B58;&#x5230;boot_args[2]&#x3001;boot_args[3]</span></span>

    dmb sy              <span class="hljs-comment">// needed before dc ivac with</span>
                        <span class="hljs-comment">// MMU off</span>

    add x1, x0, <span class="hljs-meta">#0x20        <span class="hljs-comment">// x0&#x3001;x1&#x4F5C;&#x4E3A;nval_cache_range&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;</span></span>
    b   __inval_cache_range     <span class="hljs-comment">// tail call</span>
ENDPROC(preserve_boot_args)
</code></pre>
<h5 id="2-el2setup">2. el2_setup</h5>
<p>&#x5230;&#x6B64;&#xFF0C;CPU&#x5904;&#x4E8E;&#x54EA;&#x4E2A;exception level&#xFF1F;&#x6839;&#x636E;ARM64 boot protocol&#xFF0C;CPU&#x5904;&#x4E8E;EL2&#xFF08;&#x63A8;&#x8350;&#xFF09;&#x6216;&#x8005;secure EL1&#xFF1B;&#x5982;&#x679C;&#x5904;&#x4E8E;EL2&#xFF0C;&#x9700;&#x8981;&#x5C06;CPU&#x9000;&#x56DE;&#x5230;EL1&#xFF1B;&#x6B64;&#x90E8;&#x5206;&#x8FD8;&#x6CA1;&#x6709;&#x641E;&#x660E;&#x767D;&#xFF0C;&#x6682;&#x65F6;&#x5148;&#x8DF3;&#x8FC7;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/head.S</span>
ENTRY(el2_setup)
    ......
ENDPROC(el2_setup)
</code></pre>
<h5 id="3-setcpubootmodeflag">3. set_cpu_boot_mode_flag</h5>
<p>set_cpu_boot_mode_flag&#x51FD;&#x6570;&#xFF0C;&#x7528;&#x6765;&#x8BBE;&#x7F6E;__boot_cpu_mode flag&#xFF1B;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x524D;&#x63D0;&#x6761;&#x4EF6;&#xFF1A;w20&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#x4FDD;&#x5B58;&#x4E86;CPU&#x542F;&#x52A8;&#x65F6;&#x7684;&#x5F02;&#x5E38;&#x7B49;&#x7EA7;&#xFF08;Exception level&#xFF09;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/head.S</span>
set_cpu_boot_mode_flag:
    adr_l   x1, __boot_cpu_mode
    cmp w0, <span class="hljs-meta">#BOOT_CPU_MODE_EL2</span>
    b.ne    <span class="hljs-number">1f</span>
    add x1, x1, <span class="hljs-meta">#4</span>
<span class="hljs-number">1</span>:  str w0, [x1]            <span class="hljs-comment">// This CPU has booted in EL1</span>
    dmb sy
    dc  ivac, x1            <span class="hljs-comment">// Invalidate potentially stale cache line</span>
    <span class="hljs-function">ret
<span class="hljs-title">ENDPROC</span><span class="hljs-params">(set_cpu_boot_mode_flag)</span>
</span></code></pre>
<p>&#x7531;&#x4E8E;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x4E4B;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x4E86;&#x89E3;CPU&#x542F;&#x52A8;&#x65F6;&#x5019;&#x7684;Exception level&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;__boot_cpu_mode&#x6765;&#x4FDD;&#x5B58;&#x542F;&#x52A8;&#x65F6;&#x7684;CPU mode&#xFF1B;</p>
<p>&#x5168;&#x5C40;&#x53D8;&#x91CF;__boot_cpu_mode&#x5B9A;&#x4E49;&#xFF1A;</p>
<pre><code class="lang-c">ENTRY(__boot_cpu_mode)
    .<span class="hljs-keyword">long</span>   BOOT_CPU_MODE_EL2
    .<span class="hljs-keyword">long</span>   BOOT_CPU_MODE_EL1
</code></pre>
<h5 id="4-createpagetables">4. __create_page_tables</h5>
<p>&#x5EFA;&#x7ACB;&#x9875;&#x8868;&#x521D;&#x59CB;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/head.S</span>
__create_page_tables:
    ......
ENDPROC(__create_page_tables)
</code></pre>
<h5 id="5-cpusetup">5. __cpu_setup</h5>
<p>CPU&#x7684;&#x521D;&#x59CB;&#x5316;&#x8BBE;&#x7F6E;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/mm/proc.S</span>
ENTRY(__cpu_setup)
    ......
ENDPROC(__cpu_setup)
</code></pre>
<p>&#x4E3B;&#x8981;&#x7684;&#x5185;&#x5BB9;&#x5305;&#x62EC;&#xFF1A;</p>
<blockquote>
<pre><code>1&#x3001;cache&#x548C;TLB&#x7684;&#x5904;&#x7406;
2&#x3001;Memory attributes lookup table&#x7684;&#x521B;&#x5EFA;
3&#x3001;SCTLR_EL1&#x3001;TCR_EL1&#x7684;&#x8BBE;&#x5B9A;
</code></pre></blockquote>
<h5 id="6-primaryswitch">6. __primary_switch</h5>
<p>&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x662F;&#x4E3A;&#x6253;&#x5F00;MMU&#x505A;&#x51C6;&#x5907;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/head.S</span>
__primary_switch:
    ......
    bl  __enable_mmu            <span class="hljs-comment">// &#x5F00;&#x542F;MMU</span>
    ......
    ldr x8, =__primary_switched
    adrp    x0, __<span class="hljs-function">PHYS_OFFSET
    blr x8
<span class="hljs-title">ENDPROC</span><span class="hljs-params">(__primary_switch)</span>
</span></code></pre>
<p>&#x5728;&#x51FD;&#x6570;&#x4E2D;&#x901A;&#x8FC7;__enable_mmu&#x51FD;&#x6570;&#x6765;&#x5F00;&#x542F;MMU&#xFF0C;&#x5E76;&#x8C03;&#x7528;__primary_switched&#x51FD;&#x6570;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/head.S</span>
__primary_switched:
    ......
    <span class="hljs-function">b   start_kernel
<span class="hljs-title">ENDPROC</span><span class="hljs-params">(__primary_switched)</span>
</span></code></pre>
<p>&#x5728;__primary_switched&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;C&#x73AF;&#x5883;&#x7684;&#x51C6;&#x5907;&#xFF0C;&#x5E76;&#x5728;&#x6700;&#x540E;&#xFF0C;&#x8C03;&#x7528;&#x6267;&#x884C;start_kernel&#x51FD;&#x6570;&#xFF0C;&#x5185;&#x6838;&#x7684;&#x542F;&#x52A8;&#x8FDB;&#x5165;&#x5230;C&#x8BED;&#x8A00;&#x73AF;&#x5883;&#x9636;&#x6BB5;&#xFF1B;</p>
<pre><code class="lang-mermaid">graph TB
    subgraph &#x5165;&#x53E3;&#x51FD;&#x6570;
    A_Explain(&#x4FDD;&#x5B58;boot&#x53C2;&#x6570;)
    --&gt;
    B_Explain(EL2&#x8BBE;&#x7F6E;)
    --&gt;
    C_Explain(&#x8BBE;&#x7F6E;CPU&#x542F;&#x52A8;&#x6A21;&#x5F0F;flag)
    --&gt;
    D_Explain(&#x521B;&#x5EFA;&#x9875;&#x8868;)
    --&gt;
    E_Explain(CPU&#x914D;&#x7F6E;)
    --&gt;
    F_Explain(&#x4E3B;&#x8981;&#x7684;&#x8F6C;&#x6362;&#x64CD;&#x4F5C;)
    --&gt;
    G_Explain(&#x8FD0;&#x884C;start_kernel&#x51FD;&#x6570;)
    end

    subgraph stext
    A_func(preserve_boot_args)
    --&gt;
    B_func(el2_setup)
    --&gt;
    C_func(set_cpu_boot_mode_flag)
    --&gt;
    D_func(__create_page_tables)
    --&gt;
    E_func(__cpu_setup)
    --&gt;
    F_func(__primary_switch)
    --&gt;
    G_func(start_kernel)
    end
</code></pre>
<h4 id="23-&#x53C2;&#x8003;&#x8D44;&#x6599;">2.3 &#x53C2;&#x8003;&#x8D44;&#x6599;</h4>
<p><a href="https://blog.csdn.net/xiaohua0877/article/details/78615776" target="_blank">https://blog.csdn.net/xiaohua0877/article/details/78615776</a></p>
<p><a href="http://www.wowotech.net/sort/armv8a_arch" target="_blank">http://www.wowotech.net/sort/armv8a_arch</a></p>
<h3 id="3-&#x5185;&#x6838;&#x542F;&#x52A8;&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;">3. &#x5185;&#x6838;&#x542F;&#x52A8;&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;</h3>
<p>Linux&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#x4E5F;&#x5C31;&#x662F;&#x5E38;&#x8BF4;&#x7684;C&#x8BED;&#x8A00;&#x9636;&#x6BB5;&#xFF0C;&#x4ECE;start_kernel()&#x51FD;&#x6570;&#x5F00;&#x59CB;&#xFF1B;start_kernel()&#x51FD;&#x6570;&#x662F;&#x6240;&#x6709;Linux&#x5E73;&#x53F0;&#x8FDB;&#x5165;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x521D;&#x59CB;&#x5316;&#x540E;&#x7684;&#x5165;&#x53E3;&#x51FD;&#x6570;&#xFF1B;&#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x5269;&#x4F59;&#x7684;&#x4E0E;&#x786C;&#x4EF6;&#x5E73;&#x53F0;&#x76F8;&#x5173;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#xFF0C;&#x8FD9;&#x4E9B;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;&#xFF0C;&#x6709;&#x7684;&#x662F;&#x516C;&#x5171;&#x7684;&#xFF0C;&#x6709;&#x7684;&#x662F;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x624D;&#x4F1A;&#x6267;&#x884C;&#x7684;&#xFF1B;&#x5185;&#x6838;&#x5DE5;&#x4F5C;&#x9700;&#x8981;&#x7684;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x4F9D;&#x6B21;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x5982;&#xFF1A;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x3001;&#x8C03;&#x5EA6;&#x7CFB;&#x7EDF;&#x3001;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7B49;&#xFF1B;</p>
<pre><code class="lang-mermaid">graph TB
    A(start_kernel)--&gt;B(&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;)
    subgraph start_kernel
    B(&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;)
    --&gt;
    C(setup_arch)
    --&gt;
    D(&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;)
    --&gt;
    E(rest_init)
    end
</code></pre>
<h4 id="31-startkernel">3.1 start_kernel</h4>
<p>start_kernel()&#x51FD;&#x6570;&#x5728;init/main.c&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x4E3B;&#x8981;&#x5B8C;&#x6210;Linux&#x5B50;&#x7CFB;&#x7EDF;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#xFF1B;&#x6B64;&#x90E8;&#x5206;&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;&#x7E41;&#x591A;&#xFF0C;&#x6682;&#x65F6;&#x5148;&#x7565;&#x8FC7;&#xFF0C;&#x6B64;&#x5904;&#x7701;&#x7565;&#x597D;&#x591A;&#x5B57;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
asmlinkage __visible <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">start_kernel</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    ......
}
</code></pre>
<pre><code class="lang-c">pr_notice(<span class="hljs-string">&quot;%s&quot;</span>, linux_banner);
</code></pre>
<pre><code class="lang-c"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> linux_banner[] =
    <span class="hljs-string">&quot;Linux version &quot;</span> UTS_RELEASE <span class="hljs-string">&quot; (&quot;</span> LINUX_COMPILE_BY <span class="hljs-string">&quot;@&quot;</span>
    LINUX_COMPILE_HOST <span class="hljs-string">&quot;) (&quot;</span> LINUX_COMPILER <span class="hljs-string">&quot;) &quot;</span> UTS_VERSION <span class="hljs-string">&quot;\n&quot;</span>;
</code></pre>
<p>&#x6267;&#x884C;&#x7684;&#x6548;&#x679C;&#x662F;&#xFF0C;&#x5728;&#x5185;&#x6838;&#x542F;&#x52A8;&#x521D;&#x671F;&#xFF0C;&#x6253;&#x5370;&#x5185;&#x6838;&#x7248;&#x672C;&#x53F7;&#x548C;&#x6784;&#x5EFA;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre><code class="lang-shell">Linux version 4.9.115 (root@localhost.localdomain) (gcc version 6.2.0 20170314 ZTE Embsys-TSP V3.06.40 (GCC) ) #2 SMP PREEMPT Tue Mar 10 11:21:00 CST 2020
</code></pre>
<h4 id="32-setuparch">3.2 setup_arch</h4>
<p>setup_arch()&#x51FD;&#x6570;&#xFF0C;&#x662F;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;&#x76F8;&#x5173;&#x7684;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x6839;&#x636E;&#x5904;&#x7406;&#x5668;&#x3001;&#x786C;&#x4EF6;&#x5E73;&#x53F0;&#x5177;&#x4F53;&#x578B;&#x53F7;&#x8BBE;&#x7F6E;&#x7CFB;&#x7EDF;&#xFF1B;&#x53CA;&#x89E3;&#x6790;&#x7CFB;&#x7EDF;&#x547D;&#x4EE4;&#x884C;&#xFF0C;&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x7EDF;&#x8BA1;&#x5E76;&#x6CE8;&#x518C;&#x7CFB;&#x7EDF;&#x5404;&#x79CD;&#x8D44;&#x6E90;&#x7B49;&#xFF1B;&#x6BCF;&#x4E2A;&#x4F53;&#x7CFB;&#x90FD;&#x6709;&#x81EA;&#x5DF1;&#x7684;setup_arch()&#x51FD;&#x6570;&#xFF0C;&#x662F;&#x7531;&#x9876;&#x5C42;Makefile&#x4E2D;&#x7684;ARCH&#x53D8;&#x91CF;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x662F;ARCH=arm64&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;setup_arch()&#x51FD;&#x6570;&#xFF0C;&#x4E5F;&#x662F;arm64&#x7684;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;&#x76F8;&#x5173;&#x7684;&#xFF1B;&#x53C2;&#x6570;&#x662F;&#x672A;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5185;&#x90E8;&#x53D8;&#x91CF;command_line&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
asmlinkage __visible <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">start_kernel</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    ......
    setup_arch(&amp;command_line);
    ......
}
</code></pre>
<p>setup_arch()&#x51FD;&#x6570;&#x4E2D;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x76EE;&#x524D;<strong>&#x53EA;&#x5BF9;&#x8BBE;&#x5907;&#x6811;&#x76F8;&#x5173;&#x7684;&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x7B80;&#x8981;&#x63CF;&#x8FF0;</strong>&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/setup.c</span>
<span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">setup_arch</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **cmdline_p)</span>
</span>{
    ......
    setup_machine_fdt(__fdt_pointer);
    ......
    <span class="hljs-keyword">if</span> (acpi_disabled)
        unflatten_device_tree();
    ......
}
</code></pre>
<pre><code class="lang-mermaid">graph LR
    A(setup_arch)--&gt;B(&#x52A0;&#x8F7D;&#x8BBE;&#x5907;&#x6811;)
    B(&#x52A0;&#x8F7D;&#x8BBE;&#x5907;&#x6811;)--&gt;C(setup_machine_fdt)
    B(&#x52A0;&#x8F7D;&#x8BBE;&#x5907;&#x6811;)--&gt;D(unflatten_device_tree)
</code></pre>
<h5 id="1-setupmachinefdt">1. setup_machine_fdt</h5>
<p>setup<em>machine_fdt()&#x51FD;&#x6570;&#x7684;&#x8F93;&#x5165;&#x53C2;&#x6570;&#x662F;&#x8BBE;&#x5907;&#x6811;&#xFF08;DTB&#xFF09;&#x9996;&#x5730;&#x5740;&#xFF1B;uboot&#x542F;&#x52A8;&#x7A0B;&#x5E8F;&#x628A;&#x8BBE;&#x5907;&#x6811;&#x8BFB;&#x53D6;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x4E4B;&#x540E;&#x5728;&#x542F;&#x52A8;&#x5185;&#x6838;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x5C06;&#x8BBE;&#x5907;&#x6811;&#x9996;&#x5730;&#x5740;&#x4F20;&#x7ED9;&#x5185;&#x6838;&#xFF0C;setup_machine_fdt()&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;\</em>_fdt_pointer&#x5C31;&#x662F;uboot&#x4F20;&#x7ED9;&#x5185;&#x6838;&#x7684;&#x8BBE;&#x5907;&#x6811;&#x5730;&#x5740;&#xFF1B;&#x51FD;&#x6570;&#x4E2D;&#x7684;fdt(flat device tree)&#x8868;&#x793A;&#xFF0C;&#x8BBE;&#x5907;&#x6811;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x662F;&#x5728;&#x4E00;&#x5757;&#x8FDE;&#x7EED;&#x5730;&#x5740;&#x5B58;&#x50A8;&#x7684;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/setup.c</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">setup_machine_fdt</span><span class="hljs-params">(phys_addr_t dt_phys)</span>
</span>{
    <span class="hljs-keyword">void</span> *dt_virt = fixmap_remap_fdt(dt_phys);

    <span class="hljs-keyword">if</span> (!dt_virt || !early_init_dt_scan(dt_virt)) {
        ......
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
            cpu_relax();
    }

    dump_stack_set_arch_desc(<span class="hljs-string">&quot;%s (DT)&quot;</span>, of_flat_dt_get_machine_name());
}
</code></pre>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/kernel/setup.c</span>
<span class="hljs-keyword">phys_addr_t</span> __fdt_pointer __initdata;
</code></pre>
<p>&#x5168;&#x5C40;&#x53D8;&#x91CF;__fdt_pointer&#x6307;&#x5411;&#x5185;&#x5B58;&#x4E2D;&#x7684;DTB&#xFF0C;&#x662F;&#x8BBE;&#x5907;&#x6811;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#xFF1B;&#x8FD9;&#x4E2A;&#x7269;&#x7406;&#x5730;&#x5740;&#x662F;&#x7531;bootloader&#x4F20;&#x9012;&#x7ED9;&#x5185;&#x6838;&#x7684;&#xFF0C;&#x5728;&#x5185;&#x6838;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x662F;&#x9700;&#x8981;&#x8F6C;&#x6362;&#x4E3A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x624D;&#x80FD;&#x8BBF;&#x95EE;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x8F6C;&#x6362;&#xFF0C;&#x7531;fixmap_remap_fdt()&#x51FD;&#x6570;&#x6765;&#x5B8C;&#x6210;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/of/fdt.c</span>
<span class="hljs-keyword">bool</span> __<span class="hljs-function">init <span class="hljs-title">early_init_dt_scan</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *params)</span>
</span>{
    <span class="hljs-keyword">bool</span> status;

    status = early_init_dt_verify(params);
    <span class="hljs-keyword">if</span> (!status)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    early_init_dt_scan_nodes();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#x8C03;&#x7528;&#x7684;early_init_dt_scan()&#x51FD;&#x6570;&#xFF0C;&#x901A;&#x8FC7;&#x8FDB;&#x4E00;&#x6B65;&#x8C03;&#x7528;early_init_dt_verify()&#x51FD;&#x6570;&#x6765;&#x68C0;&#x67E5;DTB&#x6570;&#x636E;&#x662F;&#x5426;&#x5B8C;&#x6574;&#xFF0C;&#x7ECF;&#x8FC7;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;DTB&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x4E86;&#xFF1B;</p>
<h5 id="2-unflattendevicetree">2. unflatten_device_tree</h5>
<p>unflatten_device_tree()&#x51FD;&#x6570;&#x5B8C;&#x6210;&#x5BF9;&#x8BBE;&#x5907;&#x6811;&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x6240;&#x505A;&#x7684;&#x5DE5;&#x4F5C;&#x662F;&#x5C06;&#x8BBE;&#x5907;&#x6811;&#x5404;&#x8282;&#x70B9;&#x8F6C;&#x6362;&#x6210;&#x76F8;&#x5E94;&#x7684;struct device_node&#x7ED3;&#x6784;&#x4F53;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/of/fdt.c</span>
<span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">unflatten_device_tree</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    __unflatten_device_tree(initial_boot_params, <span class="hljs-literal">NULL</span>, &amp;of_root,
                early_init_dt_alloc_memory_arch, <span class="hljs-literal">false</span>);

    <span class="hljs-comment">/* Get pointer to &quot;/chosen&quot; and &quot;/aliases&quot; nodes for use everywhere */</span>
    of_alias_scan(early_init_dt_alloc_memory_arch);
}
</code></pre>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/of/base.c</span>
<span class="hljs-keyword">struct</span> device_node *of_root;
</code></pre>
<pre><code class="lang-c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *__unflatten_device_tree(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *blob,
                     <span class="hljs-keyword">struct</span> device_node *dad,
                     <span class="hljs-keyword">struct</span> device_node **mynodes,
                     <span class="hljs-keyword">void</span> *(*dt_alloc)(u64 size, u64 align),
                     <span class="hljs-keyword">bool</span> detached)
{
    ......
    <span class="hljs-comment">/* First pass, scan for size */</span>
    size = unflatten_dt_nodes(blob, <span class="hljs-literal">NULL</span>, dad, <span class="hljs-literal">NULL</span>);
    ......
    <span class="hljs-comment">/* Allocate memory for the expanded device tree */</span>
    mem = dt_alloc(size + <span class="hljs-number">4</span>, __alignof__(<span class="hljs-keyword">struct</span> device_node));
    ......
    <span class="hljs-comment">/* Second pass, do actual unflattening */</span>
    unflatten_dt_nodes(blob, mem, dad, mynodes);
    ......
}
</code></pre>
<p>__unflatten_device_tree()&#x51FD;&#x6570;&#x4E2D;&#x4E3B;&#x8981;&#x7684;&#x89E3;&#x6790;&#x51FD;&#x6570;&#x662F;unflatten_dt_nodes()&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x88AB;&#x8C03;&#x7528;&#x4E86;&#x4E24;&#x6B21;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x662F;&#x626B;&#x63CF;&#x51FA;&#x8BBE;&#x5907;&#x6811;&#x8F6C;&#x6362;&#x6210;struct device_node&#x6240;&#x9700;&#x8981;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x7CFB;&#x7EDF;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B21;&#x662F;&#x8FDB;&#x884C;&#x771F;&#x6B63;&#x89E3;&#x6790;&#x7684;&#x5DE5;&#x4F5C;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/of/fdt.c</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">unflatten_dt_nodes</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *blob,
                  <span class="hljs-keyword">void</span> *mem,
                  <span class="hljs-keyword">struct</span> device_node *dad,
                  <span class="hljs-keyword">struct</span> device_node **nodepp)</span>
</span>{
    ......
    <span class="hljs-keyword">for</span> (offset = <span class="hljs-number">0</span>;
         offset &gt;= <span class="hljs-number">0</span> &amp;&amp; depth &gt;= initial_depth;
         offset = fdt_next_node(blob, offset, &amp;depth)) {
        fpsizes[depth+<span class="hljs-number">1</span>] = populate_node(blob, offset, &amp;mem,
                         nps[depth],
                         fpsizes[depth],
                         &amp;nps[depth+<span class="hljs-number">1</span>], dryrun);
        ......
    }
    ......
}
</code></pre>
<p>unflatten_dt_nodes()&#x51FD;&#x6570;&#xFF0C;&#x5C31;&#x662F;&#x4ECE;&#x6839;&#x8282;&#x70B9;&#x5F00;&#x59CB;&#xFF0C;&#x5BF9;&#x5B50;&#x8282;&#x70B9;&#x4F9D;&#x6B21;&#x8C03;&#x7528;populate_node()&#xFF0C;&#x4E3A;&#x5F53;&#x524D;&#x8282;&#x70B9;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x5E76;&#x5BF9;node&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF1B;&#x5E76;&#x6839;&#x636E;&#x8BFB;&#x53D6;&#x5230;&#x7684;dtb&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6309;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x586B;&#x5145;&#xFF1B;&#x8BBE;&#x5907;&#x6811;&#x7531;dtb&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#xFF0C;&#x7ECF;&#x8FC7;&#x89E3;&#x6790;&#x4E3A;&#x6BCF;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x751F;&#x6210;&#x4E00;&#x4E2A;struct device_node&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5C31;&#x5B8C;&#x6210;&#x4E86;dtb&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#xFF1B;</p>
<h4 id="33-consoleinit">3.3 console_init</h4>
<p>console_init()&#x51FD;&#x6570;&#x6267;&#x884C;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;&#xFF1B;&#x5728;console_init()&#x51FD;&#x6570;&#x6267;&#x884C;&#x4E4B;&#x524D;&#x7684;printk&#x6253;&#x5370;&#x4FE1;&#x606F;&#xFF0C;&#x9700;&#x8981;&#x5728;console_init()&#x51FD;&#x6570;&#x6267;&#x884C;&#x4E4B;&#x540E;&#x624D;&#x80FD;&#x6253;&#x5370;&#x51FA;&#x6765;&#xFF1B;&#x56E0;&#x4E3A;&#x5728;console_inie()&#x51FD;&#x6570;&#x4E4B;&#x524D;&#xFF0C;printk&#x7684;&#x6253;&#x5370;&#x4FE1;&#x606F;&#x90FD;&#x4FDD;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x533A;&#x4E2D;&#xFF0C;&#x7B49;&#x5230;console_init()&#x51FD;&#x6570;&#x6267;&#x884C;&#x4E4B;&#x540E;&#xFF0C;&#x63A7;&#x5236;&#x53F0;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x6253;&#x5370;&#x51FA;&#x6765;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/tty/tty_io.c</span>
<span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">console_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">initcall_t</span> *call;

    <span class="hljs-comment">/* Setup the default TTY line discipline. */</span>
    n_tty_init();

    <span class="hljs-comment">/*
     * set up the console device so that later boot sequences can
     * inform about problems etc..
     */</span>
    call = __con_initcall_start;
    <span class="hljs-keyword">while</span> (call &lt; __con_initcall_end) {
        (*call)();
        call++;
    }
}
</code></pre>
<p>&#x5728;console<em>init()&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x6307;&#x5B9A;initcall_t&#x7C7B;&#x578B;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x4ECE;\</em>_con_initcall_start&#x5F00;&#x59CB;&#xFF0C;&#x5230;__con_initcall_end&#x7ED3;&#x675F;&#xFF0C;&#x904D;&#x5386;&#x8FD9;&#x4E2A;&#x8303;&#x56F4;&#x4E4B;&#x95F4;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x4F9D;&#x6B21;&#x8FD0;&#x884C;&#xFF1B;</p>
<p>__con_initcall_start&#x548C;__con_initcall_end&#x8FD9;&#x4E24;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;vmlinux.lds&#x6587;&#x4EF6;&#x627E;&#x5230;&#xFF1B;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// vmlinux.lds</span>
__con_initcall_start = .;
KEEP(*(.con_initcall.init))
__con_initcall_end = .;
</code></pre>
<p>&#x8FD9;&#x4E24;&#x4E2A;&#x5730;&#x5740;&#x4E4B;&#x95F4;&#xFF0C;&#x5B58;&#x653E;&#x7684;&#x662F;.con_initcall.init&#x6BB5;&#x7684;&#x5185;&#x5BB9;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// include/linux/init.h</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> console_initcall(fn)                    \
    static initcall_t __initcall_##fn           \
    __used __section(.con_initcall.init) = fn</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x5B8F;&#x5B9A;&#x4E49;console<em>initcall(fn)&#xFF0C;&#x5C06;initcall_t&#x7C7B;&#x578B;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;fn&#xFF0C;&#x5B58;&#x653E;&#x5230;.con_initcall.init&#x6BB5;&#xFF1B;&#x4E4B;&#x540E;&#x5728;&#x8C03;&#x7528;console_init()&#x51FD;&#x6570;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x901A;&#x8FC7;&#x904D;&#x5386;</em>_con_initcall_start&#x5230;__con_initcall_end&#x7684;&#x5730;&#x5740;&#x533A;&#x57DF;&#xFF0C;&#x4F9D;&#x6B21;&#x8FD0;&#x884C;&#x5B58;&#x653E;&#x5728;&#x5176;&#x4E2D;&#x7684;&#x51FD;&#x6570;fn&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/tty/serial/8250/8250_core.c</span>
console_initcall(univ8250_console_init);
</code></pre>
<h4 id="34-restinit">3.4 rest_init</h4>
<p>&#x5728;&#x8FDB;&#x884C;&#x4E00;&#x7CFB;&#x5217;&#x4E0E;&#x5185;&#x6838;&#x76F8;&#x5173;&#x7684;&#x521D;&#x59CB;&#x5316;&#x540E;&#xFF0C;&#x5728;rest_init()&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x542F;&#x52A8;&#x4E86;&#x4E09;&#x4E2A;&#x8FDB;&#x7A0B;&#xFF1A;idle&#x3001;kernel_init&#x3001;kthreadd&#xFF0C;&#x6765;&#x5F00;&#x59CB;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x6B63;&#x5F0F;&#x8FD0;&#x884C;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
rest_init()
    kernel_thread(kernel_init, <span class="hljs-literal">NULL</span>, CLONE_FS);    <span class="hljs-comment">// &#x521B;&#x5EFA;kernel_init&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#xFF0C;&#x5373;init&#xFF0C;1&#x53F7;&#x8FDB;&#x7A0B;&#xFF1B;</span>
    pid = kernel_thread(kthreadd, <span class="hljs-literal">NULL</span>, CLONE_FS | CLONE_FILES);    <span class="hljs-comment">// &#x521B;&#x5EFA;kthreadd&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#xFF0C;2&#x53F7;&#x8FDB;&#x7A0B;&#xFF0C;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x548C;&#x8C03;&#x5EA6;&#x5176;&#x4ED6;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#xFF1B;</span>
    ......
    init_idle_bootup_task(current);    <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#xFF08;0&#x53F7;&#x8FDB;&#x7A0B;&#xFF09;&#x4E3A;idle&#x8FDB;&#x7A0B;&#xFF1B;</span>
    schedule_preempt_disabled();    <span class="hljs-comment">// &#x8C03;&#x7528;&#x8FDB;&#x7A0B;&#x8C03;&#x5EA6;&#xFF0C;&#x5E76;&#x7981;&#x6B62;&#x5185;&#x6838;&#x62A2;&#x5360;&#xFF1B;</span>
    <span class="hljs-comment">/* Call into cpu_idle with preempt disabled */</span>
    cpu_startup_entry(CPUHP_ONLINE);    <span class="hljs-comment">// 0&#x53F7;&#x8FDB;&#x7A0B;&#x5B8C;&#x6210;kernel&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#xFF0C;&#x8FDB;&#x5165;idle&#x5FAA;&#x73AF;&#xFF0C;&#x7F16;&#x7A0B;idle&#x8FDB;&#x7A0B;&#xFF1B;</span>
</code></pre>
<pre><code class="lang-mermaid">graph TB
    A(rest_init)--&gt;B(idle&#x8FDB;&#x7A0B;)
    A(rest_init)--&gt;C(kernel_init&#x8FDB;&#x7A0B;)
    A(rest_init)--&gt;D(kthreadd&#x8FDB;&#x7A0B;)
</code></pre>
<blockquote>
<ul>
<li>idle&#x8FDB;&#x7A0B;&#x662F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x7A7A;&#x95F2;&#x8FDB;&#x7A0B;&#xFF0C;CPU&#x7A7A;&#x95F2;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x53BB;&#x8FD0;&#x884C;&#x5B83;&#xFF1B;</li>
<li>kernel_init&#x8FDB;&#x7A0B;&#x6700;&#x5F00;&#x59CB;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F5C;&#x4E3A;&#x8FDB;&#x7A0B;&#x88AB;&#x542F;&#x52A8;&#xFF0C;init&#x8FDB;&#x7A0B;&#x662F;&#x6C38;&#x8FDC;&#x5B58;&#x5728;&#x7684;&#xFF0C;PID&#x662F;1&#xFF1B;</li>
<li>kthreadd&#x662F;&#x5185;&#x6838;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;&#x59CB;&#x7EC8;&#x8FD0;&#x884C;&#x5728;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#xFF0C;&#x8D1F;&#x8D23;&#x6240;&#x6709;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x7684;&#x8C03;&#x5EA6;&#x548C;&#x7BA1;&#x7406;&#xFF0C;PID&#x662F;2&#xFF1B;</li>
</ul>
</blockquote>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x540E;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x662F;idle&#xFF0C;idle&#x8FDB;&#x7A0B;&#x662F;&#x552F;&#x4E00;&#x6CA1;&#x6709;&#x901A;&#x8FC7;kernel_thread&#x6216;fork&#x4EA7;&#x751F;&#x7684;&#x8FDB;&#x7A0B;&#xFF1B;idle&#x521B;&#x5EFA;&#x4E86;kernel_init&#x8FDB;&#x7A0B;&#x4F5C;&#x4E3A;1&#x53F7;&#x8FDB;&#x7A0B;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;kthreadd&#x8FDB;&#x7A0B;&#x4F5C;&#x4E3A;2&#x53F7;&#x8FDB;&#x7A0B;&#xFF1B;</p>
<pre><code class="lang-mermaid">graph TB
    A(idle&#x8FDB;&#x7A0B;)--&gt;B(kernel_init&#x8FDB;&#x7A0B;)
    A(idle&#x8FDB;&#x7A0B;)--&gt;C(kthreadd&#x8FDB;&#x7A0B;)
</code></pre>
<h4 id="35-kernelinit">3.5 kernel_init</h4>
<p>kernel_init()&#x51FD;&#x6570;&#x5728;&#x521B;&#x5EFA;kernel_init&#x8FDB;&#x7A0B;&#x65F6;&#xFF0C;&#x4F5C;&#x4E3A;&#x8FDB;&#x7A0B;&#x88AB;&#x542F;&#x52A8;&#xFF1B;&#x867D;&#x7136;kernel_init&#x6700;&#x5F00;&#x59CB;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x6700;&#x540E;&#xFF0C;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5C06;&#x8BFB;&#x53D6;&#x6839;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0B;&#x7684;init&#x8FDB;&#x7A0B;&#xFF0C;&#x5B8C;&#x6210;&#x4ECE;&#x5185;&#x6838;&#x6001;&#x5230;&#x7528;&#x6237;&#x6001;&#x7684;&#x8F6C;&#x53D8;&#xFF0C;&#x8F6C;&#x53D8;&#x4E3A;&#x7528;&#x6237;&#x6001;&#x7684;1&#x53F7;&#x8FDB;&#x7A0B;&#xFF1B;&#x8FD9;&#x4E2A;init&#x8FDB;&#x7A0B;&#x662F;&#x6240;&#x6709;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x7A0B;&#x7684;&#x7236;&#x8FDB;&#x7A0B;&#xFF0C;&#x4EA7;&#x751F;&#x4E86;&#x5927;&#x91CF;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#xFF1B;init&#x8FDB;&#x7A0B;&#x662F;1&#x53F7;&#x8FDB;&#x7A0B;&#xFF0C;&#x662F;&#x6C38;&#x8FDC;&#x5B58;&#x5728;&#x7684;&#xFF1B;</p>
<pre><code class="lang-mermaid">graph TB
    A(kernel_init)--&gt;B(kernel_init_freeable)
    subgraph kernel_init
        B(kernel_init_freeable)
        --&gt;C(free_initmem)
        --&gt;D(ramdisk_execute_command)
        --&gt;E(execute_command)
        --&gt;F(&#x7528;&#x6237;&#x7A7A;&#x95F4;init&#x8FDB;&#x7A0B;)
    end
</code></pre>
<h4 id="36-kernelinitfreeable">3.6 kernel_init_freeable</h4>
<p>&#x7B49;&#x5F85;&#x5185;&#x6838;&#x7EBF;&#x7A0B;kthreadd&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#x3001;&#x6CE8;&#x518C;&#x5185;&#x6838;&#x9A71;&#x52A8;&#x6A21;&#x5757;do_basic_setup&#x3001;&#x542F;&#x52A8;&#x9ED8;&#x8BA4;&#x63A7;&#x5236;&#x53F0;/dev/console</p>
<p>&#x5B8C;&#x6210;&#x8BBE;&#x5907;&#x521D;&#x59CB;&#x5316;&#x4EE5;&#x53CA;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x5DE5;&#x4F5C;&#xFF1B;</p>
<pre><code class="lang-mermaid">graph TB
    A(kernel_init_freeable)--&gt;B(wait_for_completion)
    subgraph kernel_init_freeable
        B(wait_for_completion)
        --&gt;C(set_mems_allowed)
        --&gt;D(do_basic_setup)
        --&gt;E(open console)    
        --&gt;X(ramdisk_execute_command)
    end
</code></pre>
<h5 id="361-waitforcompletion">3.6.1 wait_for_completion</h5>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
kernel_init_freeable()
{
    wait_for_completion(&amp;kthreadd_done);
}
</code></pre>
<p>&#x4F7F;&#x7528;&#x5B8C;&#x6210;&#x91CF;&#x7B49;&#x5F85;kthreadd_done&#xFF0C;&#x7B49;&#x5F85;&#x5185;&#x6838;&#x7EBF;&#x7A0B;kthreadd&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#xFF1B;&#x867D;&#x7136;kernel_init&#x8FDB;&#x7A0B;&#x5148;&#x521B;&#x5EFA;&#xFF0C;&#x4F46;&#x662F;&#x8981;&#x5728;kthreadd&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#x624D;&#x80FD;&#x6267;&#x884C;&#xFF1B;&#x5728;threadd&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#x540E;&#x624D;&#x5524;&#x9192;&#x5B8C;&#x6210;&#x91CF;&#xFF0C;&#x5F00;&#x59CB;kernel_init&#x8FDB;&#x7A0B;&#x7684;&#x5DE5;&#x4F5C;&#xFF1B;</p>
<h5 id="362-dobasicsetup">3.6.2 do_basic_setup</h5>
<pre><code class="lang-mermaid">graph TB
    A(do_basic_setup)--&gt;C(driver_init)
    subgraph do_basic_setup
    C(driver_init)
    --&gt;D(do_initcalls)
    end
</code></pre>
<h6 id="2-driverinit">2. driver_init</h6>
<p>driver_init()&#x51FD;&#x6570;&#x5B8C;&#x6210;&#x4E0E;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x76F8;&#x5173;&#x7684;&#x6240;&#x6709;&#x5B50;&#x7CFB;&#x7EDF;&#x7684;&#x6784;&#x5EFA;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;Linux&#x8BBE;&#x5907;&#x9A71;&#x52A8;&#x7684;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#x6846;&#x67B6;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x53EA;&#x662F;&#x5EFA;&#x7ACB;&#x4E86;&#x76EE;&#x5F55;&#x7ED3;&#x6784;&#xFF0C;&#x662F;&#x8BBE;&#x5907;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x7684;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x5177;&#x4F53;&#x9A71;&#x52A8;&#x6A21;&#x5757;&#x7684;&#x88C5;&#x8F7D;&#x5728;do_initcalls()&#x51FD;&#x6570;&#x4E2D;&#x5B9E;&#x73B0;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// drivers/base/init.c</span>
<span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">driver_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-comment">/* These are the core pieces */</span>
    devtmpfs_init();    <span class="hljs-comment">// &#x6CE8;&#x518C;devtmpfs&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x542F;&#x52A8;devtmpfsd&#x8FDB;&#x7A0B;</span>
    devices_init();        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;&#x90E8;&#x5206;&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;/dev/devices, /dev/char, /dev/block</span>
    buses_init();        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;bus&#x5B50;&#x7CFB;&#x7EDF;</span>
    classes_init();        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;class&#x5B50;&#x7CFB;&#x7EDF;</span>
    firmware_init();    <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;firmware&#x5B50;&#x7CFB;&#x7EDF;</span>
    hypervisor_init();    <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;hypervisor&#x5B50;&#x7CFB;&#x7EDF;</span>

    <span class="hljs-comment">/* These are also core pieces, but must come after the
     * core core pieces.
     */</span>
    platform_bus_init();    <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;bus/platform&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;&#x6B64;&#x8282;&#x70B9;&#x662F;&#x6240;&#x6709;platform&#x8BBE;&#x5907;&#x548C;&#x9A71;&#x52A8;&#x7684;&#x603B;&#x7EBF;&#x6A21;&#x578B;&#xFF1B;&#x6240;&#x6709;platform&#x8BBE;&#x5907;&#x548C;&#x9A71;&#x52A8;&#x90FD;&#x4F1A;&#x6302;&#x8F7D;&#x5230;&#x8FD9;&#x4E2A;&#x603B;&#x7EBF;&#x4E0A;&#xFF1B;</span>
    cpu_dev_init();        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;device/system/cpu&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;&#x8BE5;&#x8282;&#x70B9;&#x5305;&#x542B;CPU&#x76F8;&#x5173;&#x5C5E;&#x6027;&#xFF1B;</span>
    memory_dev_init();    <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x9A71;&#x52A8;&#x6A21;&#x578B;&#x4E2D;&#x7684;device/system/memory&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;&#x8BE5;&#x8282;&#x70B9;&#x5305;&#x542B;&#x4E86;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x5C5E;&#x6027;&#xFF1B;</span>
    container_dev_init();    <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x7CFB;&#x7EDF;&#x603B;&#x7EBF;&#x7C7B;&#x578B;&#x4E3A;&#x5BB9;&#x5668;&#xFF1B;</span>
    of_core_init();        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x521B;&#x5EFA;&#xFF0C;&#x8BBF;&#x95EE;&#x548C;&#x7ED3;&#x65F6;&#x8BBE;&#x5907;&#x6811;&#x7684;&#x8FC7;&#x7A0B;&#xFF1B;</span>
}
</code></pre>
<h6 id="3-doinitcalls">3. do_initcalls</h6>
<p>&#x7F16;&#x8BD1;&#x5668;&#x5728;&#x7F16;&#x8BD1;&#x5185;&#x6838;&#x65F6;&#xFF0C;&#x5C06;&#x4E00;&#x7CFB;&#x5217;&#x6A21;&#x5757;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x6309;&#x7167;&#x4E00;&#x5B9A;&#x987A;&#x5E8F;&#xFF0C;&#x653E;&#x5728;&#x540D;&#x4E3A;section&#x7684;&#x6BB5;&#x4E2D;&#xFF1B;&#x5728;&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x521D;&#x59CB;&#x5316;&#x9636;&#x6BB5;&#xFF0C;do_initcalls()&#x51FD;&#x6570;&#x4E2D;&#x4EE5;&#x51FD;&#x6570;&#x6307;&#x9488;&#x7684;&#x5F62;&#x5F0F;&#x53D6;&#x51FA;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x7684;&#x5176;&#x5B9E;&#x5730;&#x5740;&#xFF0C;&#x4F9D;&#x6B21;&#x8FD0;&#x884C;&#xFF0C;&#x4EE5;&#x5B8C;&#x6210;&#x76F8;&#x5E94;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;&#xFF0C;&#x662F;&#x8BBE;&#x5907;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x7684;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#xFF1B;&#x7531;&#x4E8E;&#x5185;&#x6838;&#x6A21;&#x5757;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#xFF0C;&#x5373;&#x67D0;&#x4E9B;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x5176;&#x4ED6;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x6765;&#x5B8C;&#x6210;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x4E9B;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x987A;&#x5E8F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF1B;</p>
<p>&#x4F9D;&#x6B21;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7B49;&#x7EA7;&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">do_initcalls</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">int</span> level;

    <span class="hljs-comment">// &#x4F9D;&#x6B21;&#x8C03;&#x7528;&#x4E0D;&#x540C;level&#x7B49;&#x7EA7;&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;</span>
    <span class="hljs-keyword">for</span> (level = <span class="hljs-number">0</span>; level &lt; ARRAY_SIZE(initcall_levels) - <span class="hljs-number">1</span>; level++)
        do_initcall_level(level);
}
</code></pre>
<p>&#x5BF9;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;level&#x7B49;&#x7EA7;&#x4E0B;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x4F9D;&#x6B21;&#x904D;&#x5386;&#x6267;&#x884C;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">do_initcall_level</span><span class="hljs-params">(<span class="hljs-keyword">int</span> level)</span>
</span>{
    <span class="hljs-keyword">initcall_t</span> *fn;

    <span class="hljs-built_in">strcpy</span>(initcall_command_line, saved_command_line);
    parse_args(initcall_level_names[level],
           initcall_command_line, __start___param,
           __stop___param - __start___param,
           level, level,
           <span class="hljs-literal">NULL</span>, &amp;repair_env_string);

    <span class="hljs-comment">// &#x5BF9;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;level&#x7B49;&#x7EA7;&#x4E0B;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x4F9D;&#x6B21;&#x904D;&#x5386;&#x6267;&#x884C;&#xFF1B;</span>
    <span class="hljs-keyword">for</span> (fn = initcall_levels[level]; fn &lt; initcall_levels[level+<span class="hljs-number">1</span>]; fn++)
        do_one_initcall(*fn);
}
</code></pre>
<p>&#x5F00;&#x59CB;&#x6267;&#x884C;&#x67D0;&#x4E00;&#x4E2A;&#x786E;&#x5B9A;&#x7684;&#x51FD;&#x6570;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
<span class="hljs-keyword">int</span> __<span class="hljs-function">init_or_module <span class="hljs-title">do_one_initcall</span><span class="hljs-params">(initcall_t fn)</span>
</span>{
    <span class="hljs-keyword">int</span> count = preempt_count();
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">char</span> msgbuf[<span class="hljs-number">64</span>];

    <span class="hljs-keyword">if</span> (initcall_blacklisted(fn))
        <span class="hljs-keyword">return</span> -EPERM;

    <span class="hljs-keyword">if</span> (initcall_debug)
        ret = do_one_initcall_debug(fn);
    <span class="hljs-keyword">else</span>
        ret = fn();

    msgbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (preempt_count() != count) {
        <span class="hljs-built_in">sprintf</span>(msgbuf, <span class="hljs-string">&quot;preemption imbalance &quot;</span>);
        preempt_count_set(count);
    }
    <span class="hljs-keyword">if</span> (irqs_disabled()) {
        strlcat(msgbuf, <span class="hljs-string">&quot;disabled interrupts &quot;</span>, <span class="hljs-keyword">sizeof</span>(msgbuf));
        local_irq_enable();
    }
    WARN(msgbuf[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;initcall %pF returned with %s\n&quot;</span>, fn, msgbuf);

    add_latent_entropy();
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<p>&#x7F16;&#x8BD1;&#x5230;&#x5185;&#x6838;&#x4E2D;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x662F;&#x6309;&#x7167;&#x6267;&#x884C;&#x7684;level&#x7B49;&#x7EA7;&#xFF0C;&#x5C06;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;&#x6307;&#x9488;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x653E;&#x5230;&#x76F8;&#x5BF9;&#x5E94;level&#x7B49;&#x7EA7;&#x7684;section&#x4E2D;&#x7684;&#xFF1B;</p>
<p>initcall_t&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x7C7B;&#x578B;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(*initcall_t)</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
</code></pre>
<pre><code class="lang-c"><span class="hljs-comment">// include/linux/init.h</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __define_initcall(fn, id) \
    static initcall_t __initcall_##fn##id __used \
    __attribute__((__section__(<span class="hljs-string">&quot;.initcall&quot;</span> #id <span class="hljs-string">&quot;.init&quot;</span>))) = fn;</span>
</code></pre>
<p>__attribute__((__section__())) &#x8868;&#x793A;&#x628A;&#x5BF9;&#x8C61;&#x653E;&#x5728;&#x8FD9;&#x4E2A;&#x7531;&#x62EC;&#x53F7;&#x4E2D;&#x7684;&#x540D;&#x79F0;&#x6240;&#x6307;&#x4EE3;&#x7684;section&#x4E2D;&#xFF1B;</p>
<p>__define_initcall()&#x5B8F;&#x7684;&#x542B;&#x4E49;&#x662F;&#xFF1A;</p>
<blockquote>
<ol>
<li>&#x58F0;&#x660E;&#x4E00;&#x4E2A;&#x540D;&#x79F0;&#x4E3A;__initcall_##fn&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF08;&#x5176;&#x4E2D;##&#x8868;&#x793A;&#x5C06;&#x4E24;&#x8FB9;&#x7684;&#x53D8;&#x91CF;&#x8FDE;&#x63A5;&#x4E3A;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#xFF09;&#xFF1B;</li>
<li>&#x5C06;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x521D;&#x59CB;&#x5316;&#x4E3A;fn&#xFF1B;</li>
<li>&#x7F16;&#x8BD1;&#x65F6;&#xFF0C;&#x8981;&#x5C06;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x53D8;&#x91CF;&#x653E;&#x5230;&#x540D;&#x79F0;&#x4E3A;&quot;.initcall&quot; #id &quot;.init&quot;&#x7684;section&#x4E2D;&#xFF1B;&#xFF08;&#x6BD4;&#x5982;&#xFF1A;level=&quot;2&quot;&#xFF0C;&#x8868;&#x793A;&#x8FD9;&#x4E2A;section&#x7684;&#x540D;&#x79F0;&#x4E3A;&quot;.initcall2.init&quot;&#xFF09;</li>
</ol>
<p>&#x4E3E;&#x4F8B;&#xFF1A;</p>
<pre><code> \_\_define\_initcall(6, pci\_init)
</code></pre><p>&#x542B;&#x4E49;&#xFF1A;</p>
<ol>
<li>&#x58F0;&#x660E;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x5E76;&#x8D4B;&#x503C;&#xFF1A;__initcall_pci_init = pci_init&#xFF1B;</li>
<li><ol>
<li>&#x7F16;&#x8BD1;&#x65F6;&#x8981;&#x5C06;&#x51FD;&#x6570;&#x6307;&#x9488;&#x53D8;&#x91CF;__initcall_pci_init&#x653E;&#x5230;&#x540D;&#x79F0;&#x4E3A;initcall6.init&#x7684;section&#x4E2D;&#xFF1B;&#xFF08;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5C06;pci_init&#x51FD;&#x6570;&#x7684;&#x9996;&#x5730;&#x5740;&#x653E;&#x5230;&#x540D;&#x79F0;&#x4E3A;initcall6.init&#x7684;section&#x4E2D;&#xFF09;</li>
</ol>
</li>
</ol>
</blockquote>
<p>__define_initcall()&#x5B8F;&#x5E76;&#x4E0D;&#x4F1A;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#xFF0C;&#x800C;&#x662F;&#x88AB;&#x5B9A;&#x4E49;&#x4E3A;&#x5176;&#x4ED6;&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x5F62;&#x5F0F;&#x4F7F;&#x7528;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// include/linux/init.h</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> pure_initcall(fn)       __define_initcall(fn, 0)</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> core_initcall(fn)       __define_initcall(fn, 1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> core_initcall_sync(fn)      __define_initcall(fn, 1s)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> postcore_initcall(fn)       __define_initcall(fn, 2)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> postcore_initcall_sync(fn)  __define_initcall(fn, 2s)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> arch_initcall(fn)       __define_initcall(fn, 3)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> arch_initcall_sync(fn)      __define_initcall(fn, 3s)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> subsys_initcall(fn)     __define_initcall(fn, 4)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> subsys_initcall_sync(fn)    __define_initcall(fn, 4s)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> fs_initcall(fn)         __define_initcall(fn, 5)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> fs_initcall_sync(fn)        __define_initcall(fn, 5s)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> rootfs_initcall(fn)     __define_initcall(fn, rootfs)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> device_initcall(fn)     __define_initcall(fn, 6)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> device_initcall_sync(fn)    __define_initcall(fn, 6s)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> late_initcall(fn)       __define_initcall(fn, 7)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> late_initcall_sync(fn)      __define_initcall(fn, 7s)</span>
</code></pre>
<p>&#x901A;&#x8FC7;core_initcall()&#x6765;&#x58F0;&#x660E;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x5C06;&#x88AB;&#x653E;&#x5230;&#x540D;&#x4E3A;.initcall1.init&#x7684;section&#x4E2D;&#xFF1B;&#x901A;&#x8FC7;postcore_initcall()&#x6765;&#x58F0;&#x660E;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x5C06;&#x88AB;&#x653E;&#x5230;&#x540D;&#x4E3A;.initcall2.init&#x7684;section&#x4E2D;&#xFF1B;&#x4EE5;&#x6B64;&#x7C7B;&#x63A8;&#xFF1B;</p>
<blockquote>
<p>&#x4E3E;&#x4F8B;&#xFF1A;</p>
<pre><code> device_initcall(pci_init);
</code></pre><p>&#x542B;&#x4E49;&#xFF1A;</p>
<ol>
<li>&#x58F0;&#x660E;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x5E76;&#x8D4B;&#x503C;&#xFF1A;__initcall_pci_init = pci_init&#xFF1B;</li>
<li>&#x7F16;&#x8BD1;&#x65F6;&#x8981;&#x5C06;&#x51FD;&#x6570;&#x6307;&#x9488;&#x53D8;&#x91CF;__initcall_pci_init&#x653E;&#x5230;&#x540D;&#x79F0;&#x4E3A;initcall6.init&#x7684;section&#x4E2D;&#xFF1B;&#xFF08;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5C06;pci_init&#x51FD;&#x6570;&#x7684;&#x9996;&#x5730;&#x5740;&#x653E;&#x5230;&#x540D;&#x79F0;&#x4E3A;initcall6.init&#x7684;section&#x4E2D;&#xFF09;</li>
</ol>
</blockquote>
<p>&#x5728;&#x7F16;&#x8BD1;&#x751F;&#x6210;&#x7684;vmlinux.lds&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x627E;&#x5230;initcall&#x76F8;&#x5173;&#x7684;&#x5B9A;&#x4E49;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-comment">// tmp/bsp/DBG/BOARDLX2160LE/ARMQORIQLE/kernel/kernels/linux-4.9.115-cgel/arch/arm64/kernel/vmlinux.lds</span>
  __initcall_start = .; KEEP(*(.initcallearly.init))
  __initcall0_start = .; KEEP(*(.initcall0.init)) KEEP(*(.initcall0s.init))
  __initcall1_start = .; KEEP(*(.initcall1.init)) KEEP(*(.initcall1s.init))
  __initcall2_start = .; KEEP(*(.initcall2.init)) KEEP(*(.initcall2s.init))
  __initcall3_start = .; KEEP(*(.initcall3.init)) KEEP(*(.initcall3s.init))
  __initcall4_start = .; KEEP(*(.initcall4.init)) KEEP(*(.initcall4s.init))
  __initcall5_start = .; KEEP(*(.initcall5.init)) KEEP(*(.initcall5s.init))
  __initcallrootfs_start = .; KEEP(*(.initcallrootfs.init)) KEEP(*(.init     callrootfss.init))
  __initcall6_start = .; KEEP(*(.initcall6.init)) KEEP(*(.initcall6s.init))
  __initcall7_start = .; KEEP(*(.initcall7.init)) KEEP(*(.initcall7s.init))
  __initcall_end = .;
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E9B;section&#x4E2D;&#xFF0C;&#x603B;&#x7684;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;&#x88AB;&#x6807;&#x8BC6;&#x4E3A;__initcall_start&#xFF0C;&#x800C;&#x5728;&#x7ED3;&#x5C3E;&#x88AB;&#x6807;&#x8BC6;&#x4E3A;__initcall_end&#xFF1B;</p>
<p>do_initcalls()&#x51FD;&#x6570;&#xFF0C;&#x4F1A;&#x4ECE;&#x8FD9;&#x4E9B;section&#x4E2D;&#x4F9D;&#x6B21;&#x53D6;&#x51FA;&#x6240;&#x6709;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x5E76;&#x6309;&#x987A;&#x5E8F;&#x8C03;&#x7528;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x6307;&#x9488;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x6765;&#x5206;&#x522B;&#x5B8C;&#x6210;&#x5185;&#x6838;&#x4E2D;&#x9A71;&#x52A8;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;&#xFF1B;</p>
<p>&#x51FD;&#x6570;&#x6307;&#x9488;&#x88AB;&#x653E;&#x5230;&#x54EA;&#x4E2A;section&#x4E2D;&#xFF0C;&#x662F;&#x7531;&#x5B8F;&#x5B9A;&#x4E49;__define_initcall(fn, id)&#x7684;&#x53C2;&#x6570;id&#xFF0C;&#x4E5F;&#x5C31;&#x662F;level&#x51B3;&#x5B9A;&#x7684;&#xFF0C;&#x5BF9;&#x5E94;level&#x66F4;&#x5C0F;&#x7684;&#x5B50;section&#x7684;&#x4F4D;&#x7F6E;&#x66F4;&#x9760;&#x524D;&#xFF1B;&#x800C;&#x4F4D;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x5B50;section&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#x987A;&#x5E8F;&#x4E0D;&#x5B9A;&#xFF0C;&#x7531;&#x7F16;&#x8BD1;&#x5668;&#x6309;&#x7167;&#x7F16;&#x8BD1;&#x987A;&#x5E8F;&#x968F;&#x673A;&#x51B3;&#x5B9A;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">initcall_t</span> *initcall_levels[] __initdata = {
    __initcall0_start,
    __initcall1_start,
    __initcall2_start,
    __initcall3_start,
    __initcall4_start,
    __initcall5_start,
    __initcall6_start,
    __initcall7_start,
    __initcall_end,
};
</code></pre>
<h5 id="363-ramdiskexecutecommand">3.6.3 ramdisk_execute_command</h5>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
    <span class="hljs-keyword">if</span> (!ramdisk_execute_command)
        ramdisk_execute_command = <span class="hljs-string">&quot;/init&quot;</span>;
</code></pre>
<p>kernel_init_freeable()&#x51FD;&#x6570;&#x4F1A;&#x53BB;&#x5224;&#x65AD;ramdisk_execute_command&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x5C31;&#x76F4;&#x63A5;&#x8FD0;&#x884C;ramdisk_execute_command&#x6307;&#x5B9A;&#x7684;&#x7A0B;&#x5E8F;&#xFF1B;ramdisk_execute_command&#x7684;&#x53D6;&#x503C;&#x5206;&#x4EE5;&#x4E0B;&#x60C5;&#x51B5;&#xFF1A;</p>
<blockquote>
<ol>
<li>&#x5982;&#x679C;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x4E2D;&#x6307;&#x5B9A;&#x4E86;&#x201C;rdinit=...&#x201D;&#xFF0C;&#x5219;ramdisk_execute_command&#x7B49;&#x4E8E;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x7684;&#x7A0B;&#x5E8F;&#xFF1B;</li>
<li>&#x5426;&#x5219;&#xFF0C;&#x5982;&#x679C;/init&#x7A0B;&#x5E8F;&#x5B58;&#x5728;&#xFF0C;ramdisk_execute_command=/init&#xFF1B;</li>
<li>&#x5426;&#x5219;&#xFF0C;ramdisk_execute_command&#x4E3A;&#x7A7A;&#xFF1B;</li>
</ol>
</blockquote>
<pre><code class="lang-c"><span class="hljs-comment">// init/main.c</span>
<span class="hljs-keyword">if</span> (sys_access((<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *) ramdisk_execute_command, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>) {
    ramdisk_execute_command = <span class="hljs-literal">NULL</span>;
    prepare_namespace();
}
</code></pre>
<h4 id="37-freeinitmem">3.7 free_initmem</h4>
<p>free_initmem()&#x51FD;&#x6570;&#x7528;&#x6765;&#x91CA;&#x653E;&#x6240;&#x6709;init.&#x6BB5;&#x4E2D;&#x7684;&#x5185;&#x5B58;&#xFF1B;</p>
<pre><code class="lang-c"><span class="hljs-comment">// arch/arm64/mm/init.c</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">free_initmem</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    free_reserved_area(__va(__pa(__init_begin)), __va(__pa(__init_end)),
               <span class="hljs-number">0</span>, <span class="hljs-string">&quot;unused kernel&quot;</span>);
    <span class="hljs-comment">/*
     * Unmap the __init region but leave the VM area in place. This
     * prevents the region from being reused for kernel modules, which
     * is not supported by kallsyms.
     */</span>
    unmap_kernel_range((u64)__init_begin, (u64)(__init_end - __init_egin));
}
</code></pre>
<h4 id="38-&#x542F;&#x52A8;&#x7528;&#x6237;&#x6001;init&#x8FDB;&#x7A0B;">3.8 &#x542F;&#x52A8;&#x7528;&#x6237;&#x6001;init&#x8FDB;&#x7A0B;</h4>
<pre><code class="lang-c"><span class="hljs-comment">// kernel/init/main.c</span>
kernel_init()
    <span class="hljs-keyword">if</span> (ramdisk_execute_command) {
        ret = run_init_process(ramdisk_execute_command);
        <span class="hljs-keyword">if</span> (!ret)
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        pr_err(<span class="hljs-string">&quot;Failed to execute %s (error %d)\n&quot;</span>,
               ramdisk_execute_command, ret);
    }
    <span class="hljs-keyword">if</span> (execute_command) {
        ret = run_init_process(execute_command);
        <span class="hljs-keyword">if</span> (!ret)
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        panic(<span class="hljs-string">&quot;Requested init %s failed (error %d).&quot;</span>,
              execute_command, ret);
    }
    <span class="hljs-keyword">if</span> (!try_to_run_init_process(<span class="hljs-string">&quot;/sbin/init&quot;</span>) ||
        !try_to_run_init_process(<span class="hljs-string">&quot;/etc/init&quot;</span>) ||
        !try_to_run_init_process(<span class="hljs-string">&quot;/bin/init&quot;</span>) ||
        !try_to_run_init_process(<span class="hljs-string">&quot;/bin/sh&quot;</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">try_to_run_init_process</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *init_filename)</span>
</span>{
    <span class="hljs-keyword">int</span> ret;

    ret = run_init_process(init_filename);
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">run_init_process</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *init_filename)</span>
</span>{
    argv_init[<span class="hljs-number">0</span>] = init_filename;
    <span class="hljs-keyword">return</span> do_execve(getname_kernel(init_filename),
        (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *<span class="hljs-keyword">const</span> __user *)argv_init,
        (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *<span class="hljs-keyword">const</span> __user *)envp_init);
}
</code></pre>
<p>&#x5728;&#x5927;&#x591A;&#x6570;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;bootloader&#x4F1A;&#x4F20;&#x9012;&#x53C2;&#x6570;&#x7ED9;&#x5185;&#x6838;&#x7684;main&#x51FD;&#x6570;&#xFF0C;&#x800C;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x4E2D;&#x4F1A;&#x5305;&#x542B;init=/linuxrc&#x53C2;&#x6570;&#xFF0C;&#x4E8E;&#x662F;&#x5728;kernel_init&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x6709;execute_command = &quot;linuxrc&quot;&#xFF0C;&#x5728;&#x7ECF;&#x8FC7;run_init_process()&#x51FD;&#x6570;&#x7684;&#x89E3;&#x6790;&#x4E4B;&#x540E;&#xFF0C;&#x5F97;&#x5230;&#x9700;&#x8981;&#x8FD0;&#x884C;&#x7684;linuxrc&#xFF0C;&#x4E8E;&#x662F;linuxrc&#x7A0B;&#x5E8F;&#x5728;run_init_process()&#x51FD;&#x6570;&#x4E2D;&#x88AB;&#x6267;&#x884C;&#xFF0C;&#x901A;&#x8FC7;do_execve()&#x51FD;&#x6570;&#x8FDB;&#x5165;&#x7528;&#x6237;&#x6001;&#xFF0C;&#x5F00;&#x59CB;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x521D;&#x59CB;&#x5316;init&#x8FDB;&#x7A0B;&#xFF1B;</p>
<p>&#x5982;&#x679C;boot&#x6CA1;&#x6709;&#x4F20;&#x9012;init=/linuxrc&#x53C2;&#x6570;&#x7ED9;&#x5185;&#x6838;&#xFF0C;ramdisk_execute_command&#x548C;execute_command&#x90FD;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5F00;&#x59CB;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;/sbin/init&#x3001;/etc/init&#x3001;/bin/init&#x3001;/bin/sh&#x7A0B;&#x5E8F;&#xFF0C;&#x53EA;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#xFF0C;&#x7CFB;&#x7EDF;&#x5C31;&#x80FD;&#x591F;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#xFF1B;</p>
<pre><code class="lang-c">panic(<span class="hljs-string">&quot;No working init found.  Try passing init= option to kernel. &quot;</span>
          <span class="hljs-string">&quot;See Linux Documentation/init.txt for guidance.&quot;</span>);
</code></pre>
<p>&#x51FA;&#x73B0;&#x8FD9;&#x79CD;&#x5F02;&#x5E38;&#x9519;&#x8BEF;&#xFF0C;&#x53EF;&#x80FD;&#x662F;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x539F;&#x56E0;&#x9020;&#x6210;&#xFF1A;</p>
<blockquote>
<ol>
<li>&#x542F;&#x52A8;&#x53C2;&#x6570;&#x914D;&#x7F6E;&#x9519;&#x8BEF;&#xFF0C;&#x6307;&#x5B9A;&#x4E86;init&#xFF0C;&#x4F46;&#x662F;&#x672A;&#x627E;&#x5230;&#xFF1B;</li>
<li>&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x51FA;&#x9519;&#xFF1B;</li>
<li>&#x56DB;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x6216;&#x8005;&#x6CA1;&#x6709;&#x53EF;&#x6267;&#x884C;&#x6743;&#x9650;&#xFF1B;</li>
</ol>
</blockquote>
<p>&#x5230;&#x6B64;&#xFF0C;Linux&#x5185;&#x6838;&#x90E8;&#x5206;&#x542F;&#x52A8;&#x7ED3;&#x675F;&#xFF0C;&#x4E0B;&#x4E00;&#x6B65;&#x4F1A;&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x542F;&#x52A8;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;init&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x4E0B;&#x4E00;&#x6B65;&#x7684;&#x542F;&#x52A8;&#x64CD;&#x4F5C;&#xFF1B;</p>
<h3 id="4-filesystem&#x542F;&#x52A8;">4. filesystem&#x542F;&#x52A8;</h3>
<pre><code class="lang-mermaid">graph LR
    kernel_init(&quot;kernel_init()&quot;)--&quot;init=linuxrc&quot;--&gt;linuxrc(linuxrc)
    --&#x94FE;&#x63A5;--&gt;busybox(&quot;/bin/busybox&quot;)
    kernel_init(&quot;kernel_init()&quot;)--default--&gt;init(&quot;/sbin/init&quot;)
    --&#x94FE;&#x63A5;--&gt;busybox(&quot;/bin/busybox&quot;)
    --inittab--&gt;rcS(&quot;/etc/init.d/rcS&quot;)
</code></pre>
<h4 id="41-filesystem&#x6784;&#x5EFA;">4.1 filesystem&#x6784;&#x5EFA;</h4>
<p>&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;busybox&#x5DE5;&#x5177;&#x6765;&#x6784;&#x5EFA;&#xFF1B;&#x6784;&#x5EFA;&#x6210;&#x529F;&#x4E4B;&#x540E;&#xFF0C;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x662F;&#x4E0D;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x7684;&#xFF1B;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x7531;&#x6210;&#x7814;&#x63D0;&#x4F9B;&#xFF1B;&#x5177;&#x4F53;&#x7684;&#x6784;&#x5EFA;&#x65B9;&#x6CD5;&#x6B64;&#x5904;&#x5148;&#x7701;&#x7565;&#xFF0C;&#x6709;&#x65F6;&#x95F4;&#x518D;&#x8865;&#x4E0A;&#xFF1B;</p>
<h4 id="42-busybox&#x7A0B;&#x5E8F;">4.2 busybox&#x7A0B;&#x5E8F;</h4>
<p>&#x5728;Kernel&#x6302;&#x8F7D;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x540E;&#xFF0C;&#x901A;&#x8FC7;kernel_init()&#x51FD;&#x6570;&#xFF0C;&#x51C6;&#x5907;&#x8FD0;&#x884C;init&#x8FDB;&#x7A0B;&#xFF1B;</p>
<p>&#x5728;kernel/init/main.c&#x6587;&#x4EF6;&#x4E2D;</p>
<pre><code class="lang-c"><span class="hljs-comment">// kernel/init/main.c</span>
kernel_init()
{
    <span class="hljs-keyword">if</span> (ramdisk_execute_command) {
        ret = run_init_process(ramdisk_execute_command);
        <span class="hljs-keyword">if</span> (!ret)
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        pr_err(<span class="hljs-string">&quot;Failed to execute %s (error %d)\n&quot;</span>,
               ramdisk_execute_command, ret);
    }
    <span class="hljs-keyword">if</span> (execute_command) {
        ret = run_init_process(execute_command);
        <span class="hljs-keyword">if</span> (!ret)
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        panic(<span class="hljs-string">&quot;Requested init %s failed (error %d).&quot;</span>,
              execute_command, ret);
    }
    <span class="hljs-keyword">if</span> (!try_to_run_init_process(<span class="hljs-string">&quot;/sbin/init&quot;</span>) ||
        !try_to_run_init_process(<span class="hljs-string">&quot;/etc/init&quot;</span>) ||
        !try_to_run_init_process(<span class="hljs-string">&quot;/bin/init&quot;</span>) ||
        !try_to_run_init_process(<span class="hljs-string">&quot;/bin/sh&quot;</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>&#x7ECF;&#x8FC7;run_init_process()&#x51FD;&#x6570;&#x7684;&#x89E3;&#x6790;&#x4E4B;&#x540E;&#xFF0C;&#x5F97;&#x5230;&#x9700;&#x8981;&#x8FD0;&#x884C;&#x7684;linuxrc&#xFF0C;&#x4E8E;&#x662F;linuxrc&#x7A0B;&#x5E8F;&#x5728;run_init_process()&#x51FD;&#x6570;&#x4E2D;&#x88AB;&#x6267;&#x884C;&#xFF1B;&#x800C;linuxrc&#x6587;&#x4EF6;&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411;/bin/busybox&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x540E;&#x8FD0;&#x884C;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x7A0B;&#x5E8F;&#x662F;/bin/busybox&#xFF1B;</p>
<pre><code class="lang-shell"># ls linuxrc -l
lrwxrwxrwx 1 root root 11 Mar  4 10:04 linuxrc -&gt; bin/busybox
</code></pre>
<p>&#x5982;&#x679C;ramdisk_execute_command&#x548C;execute_command&#x90FD;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5F00;&#x59CB;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;/sbin/init&#x3001;/etc/init&#x3001;/bin/init&#x3001;/bin/sh&#x7A0B;&#x5E8F;&#xFF0C;&#x53EA;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#xFF0C;&#x7CFB;&#x7EDF;&#x5C31;&#x80FD;&#x591F;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#xFF1B;&#x800C;/sbin/init&#x6587;&#x4EF6;&#x4E5F;&#x662F;&#x94FE;&#x63A5;&#x5230;/bin/busybox&#x7684;&#xFF0C;&#x6700;&#x7EC8;&#x8FD8;&#x662F;&#x4F1A;&#x6267;&#x884C;/bin/busybox&#x7A0B;&#x5E8F;&#xFF1B;&#x521B;&#x5EFA;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x8FD0;&#x884C;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#xFF1B;</p>
<pre><code class="lang-shell"># ls /sbin/init -l
lrwxrwxrwx    1 root     root            14 Dec 12  2019 /sbin/init -&gt; ../bin/busybox
</code></pre>
<h4 id="43-init&#x8FDB;&#x7A0B;">4.3 init&#x8FDB;&#x7A0B;</h4>
<p>busybox&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#xFF0C;&#x4F1A;&#x542F;&#x52A8;init&#x8FDB;&#x7A0B;&#xFF0C;init&#x8FDB;&#x7A0B;&#x5728;Linux&#x7CFB;&#x7EDF;&#x4E2D;&#x662F;&#x6700;&#x65E9;&#x8FD0;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;1&#x53F7;&#x8FDB;&#x7A0B;&#xFF1B;</p>
<pre><code class="lang-shell"># ps -aux | grep init
root         1  0.8  0.0   2080    12 ?        Ss   18:47   0:20 init
</code></pre>
<p>init&#x8FDB;&#x7A0B;&#x8FDB;&#x884C;&#x7684;&#x5DE5;&#x4F5C;&#xFF1A;</p>
<blockquote>
<ol>
<li>&#x4E3A;init&#x8BBE;&#x7F6E;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x8FC7;&#x7A0B;</li>
<li>&#x521D;&#x59CB;&#x5316;&#x63A7;&#x5236;&#x53F0;</li>
<li>&#x89E3;&#x6790;/etc/inittab&#x6587;&#x4EF6;</li>
<li>&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x521D;&#x59CB;&#x5316;&#x547D;&#x4EE4;&#xFF0C;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x4F7F;&#x7528;/etc/init.d/rcS</li>
<li>&#x6267;&#x884C;&#x6240;&#x6709;&#x5BFC;&#x81F4;init&#x6682;&#x505C;&#x7684;inittab&#x547D;&#x4EE4;&#xFF08;&#x52A8;&#x4F5C;&#x7C7B;&#x578B;&#xFF1A;wait&#xFF09;</li>
<li>&#x6267;&#x884C;&#x6240;&#x6709;&#x4EC5;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x7684;inittab&#x547D;&#x4EE4;&#xFF08;&#x52A8;&#x4F5C;&#x7C7B;&#x578B;&#xFF1A;once&#xFF09;</li>
</ol>
</blockquote>
<p>&#x6267;&#x884C;&#x5B8C;&#x4EE5;&#x4E0A;&#x5DE5;&#x4F5C;&#x540E;&#xFF0C;init&#x8FDB;&#x7A0B;&#x4F1A;&#x5FAA;&#x73AF;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x8FDB;&#x7A0B;&#xFF1A;</p>
<blockquote>
<p>1.&#x6267;&#x884C;&#x6240;&#x6709;&#x7EC8;&#x6B62;&#x65F6;&#x5FC5;&#x987B;&#x91CD;&#x65B0;&#x542F;&#x52A8;&#x7684;inittab&#x547D;&#x4EE4;&#xFF08;&#x52A8;&#x4F5C;&#x7C7B;&#x578B;&#xFF1A;respawn&#xFF09;</p>
<p>2.&#x6267;&#x884C;&#x6240;&#x6709;&#x7EC8;&#x6B62;&#x65F6;&#x5FC5;&#x987B;&#x91CD;&#x65B0;&#x542F;&#x52A8;&#x4F46;&#x542F;&#x52A8;&#x524D;&#x5FC5;&#x987B;&#x8BE2;&#x95EE;&#x7528;&#x6237;&#x7684;inittab&#x547D;&#x4EE4;&#xFF08;&#x52A8;&#x4F5C;&#x7C7B;&#x578B;&#xFF1A;askfirst&#xFF09;</p>
</blockquote>
<h4 id="44-inittab">4.4 inittab</h4>
<p>busybox&#x7A0B;&#x5E8F;&#x89E3;&#x6790;/etc/inittab&#x6587;&#x4EF6;&#xFF0C;&#x800C;/etc/inittab&#x662F;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF1B;busybox&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x6309;&#x7167;&#x683C;&#x5F0F;&#x89E3;&#x6790;inittab&#x6587;&#x4EF6;&#xFF0C;&#x6839;&#x636E;&#x89E3;&#x6790;&#x5185;&#x5BB9;&#x51B3;&#x5B9A;&#x5177;&#x4F53;&#x5DE5;&#x4F5C;&#xFF1B;</p>
<pre><code class="lang-shell"># cat /etc/inittab
::sysinit:/etc/init.d/rcS
#::once:/bin/sw &amp;
#The followed sentence does&apos;t need password.
::respawn:-/bin/ash
#The followed sentence does need password.
#::respawn:-/bin/login
#tty2::askfirst:-/bin/ash
::ctrlaltdel:/bin/umount -a -r
</code></pre>
<p>inittab&#x7684;&#x5185;&#x5BB9;&#x4EE5;&#x884C;&#x4E3A;&#x5355;&#x4F4D;&#xFF0C;&#x884C;&#x4E0E;&#x884C;&#x4E4B;&#x95F4;&#x6CA1;&#x6709;&#x5173;&#x8054;&#xFF0C;&#x6BCF;&#x884C;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;&#x914D;&#x7F6E;&#x9879;&#xFF1B;&#x6BCF;&#x4E00;&#x884C;&#x7684;&#x914D;&#x7F6E;&#x9879;&#x90FD;&#x662F;&#x7531;3&#x4E2A;&#x5192;&#x53F7;&#x5206;&#x9694;&#x5F00;&#x7684;4&#x4E2A;&#x914D;&#x7F6E;&#x503C;&#x7EC4;&#x6210;&#xFF0C;&#x5192;&#x53F7;&#x662F;&#x5206;&#x9694;&#x7B26;&#xFF0C;&#x5206;&#x9694;&#x5F00;&#x5404;&#x4E2A;&#x90E8;&#x5206;&#xFF1B;</p>
<p>inittab&#x6587;&#x4EF6;&#x91CC;&#x7684;&#x4EE3;&#x7801;&#x683C;&#x5F0F;&#xFF1A;</p>
<p>\<id>:\<runlevels>:\<action>:\<process></process></action></runlevels></id></p>
<p>&#x8BF4;&#x660E;&#xFF1A;</p>
<blockquote>
<p>id&#xFF1A;/dev/id&#xFF0C;&#x7528;&#x4F5C;&#x7EC8;&#x7AEF;terminal&#xFF1A;stdin&#x3001;stdout&#x3001;stderr&#x3001;printf&#x3001;scanf&#x3001;err</p>
<p>runlevels&#xFF1A;</p>
<p>action&#xFF1A;&#x6267;&#x884C;&#x65F6;&#x673A;&#xFF1B;&#x5305;&#x62EC;&#xFF1A;sysinit&#x3001;respawd&#x3001;askfirst&#x3001;wait&#x3001;once&#x3001;restart&#x3001;ctrialtdel&#x3001;shutdown</p>
<p>process&#xFF1A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x811A;&#x672C;</p>
</blockquote>
<h4 id="45-rcs">4.5 rcS</h4>
<p>&#x5728;/etc/inittab&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;action&#x4E3A;sysinit&#x7684;&#x884C;&#xFF0C;&#x8868;&#x793A;&#x5728;Linux&#x7CFB;&#x7EDF;&#x521D;&#x59CB;&#x5316;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x65F6;&#x6267;&#x884C;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x811A;&#x672C;&#xFF0C;&#x5373;&#xFF1A;/etc/init.d/rcS&#xFF1B;</p>
<pre><code class="lang-shell">::sysinit:/etc/init.d/rcS
</code></pre>
<p>&#x4E3B;&#x8981;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#xFF1A;&#x542F;&#x52A8;&#x4EA4;&#x6362;&#x5206;&#x533A;&#x3001;&#x68C0;&#x67E5;&#x78C1;&#x76D8;&#x3001;&#x8BBE;&#x7F6E;&#x4E3B;&#x673A;&#x540D;&#x3001;&#x68C0;&#x67E5;&#x5E76;&#x6302;&#x8F7D;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x3001;&#x52A0;&#x8F7D;&#x5E76;&#x521D;&#x59CB;&#x5316;&#x786C;&#x4EF6;&#x6A21;&#x5757;&#x7B49;&#xFF1B;</p>
<p>/etc/init.d/rcS&#x6587;&#x4EF6;&#x662F;Linux&#x8FD0;&#x884C;&#x65F6;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x811A;&#x672C;&#x7A0B;&#x5E8F;&#xFF1B;&#x5176;&#x4ED6;&#x7684;&#x914D;&#x7F6E;&#x5728;rcS&#x6587;&#x4EF6;&#x4E2D;&#x8FDB;&#x884C;&#xFF0C;rcS&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x9700;&#x6C42;&#x8FDB;&#x884C;&#x6269;&#x5C55;&#xFF1B;/etc/init.d/rcS&#x5B8C;&#x6210;&#x5404;&#x4E2A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x6302;&#x8F7D;&#xFF08;mount&#xFF09;&#xFF0C;&#x4EE5;&#x53CA;&#x6587;&#x4EF6;&#x786C;&#x4EF6;&#x6A21;&#x5757;&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF1B;</p>
<h3 id="5-&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;">5. &#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;</h3>
<p>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;/etc/init.d/rcS&#x811A;&#x672C;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x8C03;&#x7528;xxx.sh&#x811A;&#x672C;&#x62C9;&#x8D77;&#x6765;&#x7684;&#xFF1B;</p>
<p><a href="#&#x76EE;&#x5F55;">&#x8DF3;&#x8F6C;&#x5230;&#x76EE;&#x5F55;</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="u-boot引导kernel启动过程.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: u-boot引导kernel启动过程">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Linux内核启动流程-基于ARM64","date":"2020-04-19T23:13:03.000Z","tags":"Kernel","level":"1.3.1.2","depth":3,"next":{"title":"Driver","level":"1.3.2","depth":2,"ref":"","articles":[{"title":"Linux字符设备驱动","level":"1.3.2.1","depth":3,"path":"driver/Linux字符设备驱动.md","ref":"driver/Linux字符设备驱动.md","articles":[]},{"title":"Linux块设备驱动","level":"1.3.2.2","depth":3,"path":"driver/Linux块设备驱动.md","ref":"driver/Linux块设备驱动.md","articles":[]}]},"previous":{"title":"u-boot引导kernel启动过程","level":"1.3.1.1","depth":3,"path":"bringup/u-boot引导kernel启动过程.md","ref":"bringup/u-boot引导kernel启动过程.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"bringup/Linux内核启动流程-基于ARM64.md","mtime":"2020-09-20T08:26:34.785Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-09-20T08:30:58.779Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

